!function(t,e){t&&!t.getElementById("livereloadscript")&&((e=t.createElement("script")).async=1,e.src="//"+(self.location.host||"localhost").split(":")[0]+":35729/livereload.js?snipver=1",e.id="livereloadscript",t.getElementsByTagName("head")[0].appendChild(e))}(self.document),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("fabric")):"function"==typeof define&&define.amd?define(["fabric"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).FabricPathEditor=e(t.fabric)}(this,(function(t){"use strict";function e(t,e){return t===e||t!=t&&e!=e}function r(t,r){for(var n=t.length;n--;)if(e(t[n][0],r))return n;return-1}var n=Array.prototype.splice;function o(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}o.prototype.clear=function(){this.__data__=[],this.size=0},o.prototype.delete=function(t){var e=this.__data__,o=r(e,t);return!(o<0)&&(o==e.length-1?e.pop():n.call(e,o,1),--this.size,!0)},o.prototype.get=function(t){var e=this.__data__,n=r(e,t);return n<0?void 0:e[n][1]},o.prototype.has=function(t){return r(this.__data__,t)>-1},o.prototype.set=function(t,e){var n=this.__data__,o=r(n,t);return o<0?(++this.size,n.push([t,e])):n[o][1]=e,this};var i="object"==typeof global&&global&&global.Object===Object&&global,a="object"==typeof self&&self&&self.Object===Object&&self,c=i||a||Function("return this")(),s=c.Symbol,u=Object.prototype,l=u.hasOwnProperty,f=u.toString,p=s?s.toStringTag:void 0;var h=Object.prototype.toString;var v="[object Null]",b="[object Undefined]",d=s?s.toStringTag:void 0;function y(t){return null==t?void 0===t?b:v:d&&d in Object(t)?function(t){var e=l.call(t,p),r=t[p];try{t[p]=void 0;var n=!0}catch(t){}var o=f.call(t);return n&&(e?t[p]=r:delete t[p]),o}(t):function(t){return h.call(t)}(t)}function _(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}var g="[object AsyncFunction]",j="[object Function]",m="[object GeneratorFunction]",O="[object Proxy]";function x(t){if(!_(t))return!1;var e=y(t);return e==j||e==m||e==g||e==O}var w,A=c["__core-js_shared__"],P=(w=/[^.]+$/.exec(A&&A.keys&&A.keys.IE_PROTO||""))?"Symbol(src)_1."+w:"";var E=Function.prototype.toString;function S(t){if(null!=t){try{return E.call(t)}catch(t){}try{return t+""}catch(t){}}return""}var I=/^\[object .+?Constructor\]$/,C=Function.prototype,T=Object.prototype,M=C.toString,U=T.hasOwnProperty,R=RegExp("^"+M.call(U).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function z(t){return!(!_(t)||(e=t,P&&P in e))&&(x(t)?R:I).test(S(t));var e}function k(t,e){var r=function(t,e){return null==t?void 0:t[e]}(t,e);return z(r)?r:void 0}var B=k(c,"Map"),V=k(Object,"create");var L=Object.prototype.hasOwnProperty;var N=Object.prototype.hasOwnProperty;function F(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}function D(t,e){var r,n,o=t.__data__;return("string"==(n=typeof(r=e))||"number"==n||"symbol"==n||"boolean"==n?"__proto__"!==r:null===r)?o["string"==typeof e?"string":"hash"]:o.map}function $(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}F.prototype.clear=function(){this.__data__=V?V(null):{},this.size=0},F.prototype.delete=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},F.prototype.get=function(t){var e=this.__data__;if(V){var r=e[t];return"__lodash_hash_undefined__"===r?void 0:r}return L.call(e,t)?e[t]:void 0},F.prototype.has=function(t){var e=this.__data__;return V?void 0!==e[t]:N.call(e,t)},F.prototype.set=function(t,e){var r=this.__data__;return this.size+=this.has(t)?0:1,r[t]=V&&void 0===e?"__lodash_hash_undefined__":e,this},$.prototype.clear=function(){this.size=0,this.__data__={hash:new F,map:new(B||o),string:new F}},$.prototype.delete=function(t){var e=D(this,t).delete(t);return this.size-=e?1:0,e},$.prototype.get=function(t){return D(this,t).get(t)},$.prototype.has=function(t){return D(this,t).has(t)},$.prototype.set=function(t,e){var r=D(this,t),n=r.size;return r.set(t,e),this.size+=r.size==n?0:1,this};function H(t){var e=this.__data__=new o(t);this.size=e.size}H.prototype.clear=function(){this.__data__=new o,this.size=0},H.prototype.delete=function(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r},H.prototype.get=function(t){return this.__data__.get(t)},H.prototype.has=function(t){return this.__data__.has(t)},H.prototype.set=function(t,e){var r=this.__data__;if(r instanceof o){var n=r.__data__;if(!B||n.length<199)return n.push([t,e]),this.size=++r.size,this;r=this.__data__=new $(n)}return r.set(t,e),this.size=r.size,this};var W=function(){try{var t=k(Object,"defineProperty");return t({},"",{}),t}catch(t){}}();function q(t,e,r){"__proto__"==e&&W?W(t,e,{configurable:!0,enumerable:!0,value:r,writable:!0}):t[e]=r}var G=Object.prototype.hasOwnProperty;function Q(t,r,n){var o=t[r];G.call(t,r)&&e(o,n)&&(void 0!==n||r in t)||q(t,r,n)}function X(t,e,r,n){var o=!r;r||(r={});for(var i=-1,a=e.length;++i<a;){var c=e[i],s=n?n(r[c],t[c],c,r,t):void 0;void 0===s&&(s=t[c]),o?q(r,c,s):Q(r,c,s)}return r}function Y(t){return null!=t&&"object"==typeof t}function J(t){return Y(t)&&"[object Arguments]"==y(t)}var Z=Object.prototype,K=Z.hasOwnProperty,tt=Z.propertyIsEnumerable,et=J(function(){return arguments}())?J:function(t){return Y(t)&&K.call(t,"callee")&&!tt.call(t,"callee")},rt=Array.isArray;var nt="object"==typeof exports&&exports&&!exports.nodeType&&exports,ot=nt&&"object"==typeof module&&module&&!module.nodeType&&module,it=ot&&ot.exports===nt?c.Buffer:void 0,at=(it?it.isBuffer:void 0)||function(){return!1},ct=9007199254740991,st=/^(?:0|[1-9]\d*)$/;function ut(t,e){var r=typeof t;return!!(e=null==e?ct:e)&&("number"==r||"symbol"!=r&&st.test(t))&&t>-1&&t%1==0&&t<e}var lt=9007199254740991;function ft(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=lt}var pt={};function ht(t){return function(e){return t(e)}}pt["[object Float32Array]"]=pt["[object Float64Array]"]=pt["[object Int8Array]"]=pt["[object Int16Array]"]=pt["[object Int32Array]"]=pt["[object Uint8Array]"]=pt["[object Uint8ClampedArray]"]=pt["[object Uint16Array]"]=pt["[object Uint32Array]"]=!0,pt["[object Arguments]"]=pt["[object Array]"]=pt["[object ArrayBuffer]"]=pt["[object Boolean]"]=pt["[object DataView]"]=pt["[object Date]"]=pt["[object Error]"]=pt["[object Function]"]=pt["[object Map]"]=pt["[object Number]"]=pt["[object Object]"]=pt["[object RegExp]"]=pt["[object Set]"]=pt["[object String]"]=pt["[object WeakMap]"]=!1;var vt="object"==typeof exports&&exports&&!exports.nodeType&&exports,bt=vt&&"object"==typeof module&&module&&!module.nodeType&&module,dt=bt&&bt.exports===vt&&i.process,yt=function(){try{var t=bt&&bt.require&&bt.require("util").types;return t||dt&&dt.binding&&dt.binding("util")}catch(t){}}(),_t=yt&&yt.isTypedArray,gt=_t?ht(_t):function(t){return Y(t)&&ft(t.length)&&!!pt[y(t)]},jt=Object.prototype.hasOwnProperty;function mt(t,e){var r=rt(t),n=!r&&et(t),o=!r&&!n&&at(t),i=!r&&!n&&!o&&gt(t),a=r||n||o||i,c=a?function(t,e){for(var r=-1,n=Array(t);++r<t;)n[r]=e(r);return n}(t.length,String):[],s=c.length;for(var u in t)!e&&!jt.call(t,u)||a&&("length"==u||o&&("offset"==u||"parent"==u)||i&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||ut(u,s))||c.push(u);return c}var Ot=Object.prototype;function xt(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||Ot)}function wt(t,e){return function(r){return t(e(r))}}var At=wt(Object.keys,Object),Pt=Object.prototype.hasOwnProperty;function Et(t){return null!=t&&ft(t.length)&&!x(t)}function St(t){return Et(t)?mt(t):function(t){if(!xt(t))return At(t);var e=[];for(var r in Object(t))Pt.call(t,r)&&"constructor"!=r&&e.push(r);return e}(t)}var It=Object.prototype.hasOwnProperty;function Ct(t){if(!_(t))return function(t){var e=[];if(null!=t)for(var r in Object(t))e.push(r);return e}(t);var e=xt(t),r=[];for(var n in t)("constructor"!=n||!e&&It.call(t,n))&&r.push(n);return r}function Tt(t){return Et(t)?mt(t,!0):Ct(t)}var Mt="object"==typeof exports&&exports&&!exports.nodeType&&exports,Ut=Mt&&"object"==typeof module&&module&&!module.nodeType&&module,Rt=Ut&&Ut.exports===Mt?c.Buffer:void 0,zt=Rt?Rt.allocUnsafe:void 0;function kt(){return[]}var Bt=Object.prototype.propertyIsEnumerable,Vt=Object.getOwnPropertySymbols,Lt=Vt?function(t){return null==t?[]:(t=Object(t),function(t,e){for(var r=-1,n=null==t?0:t.length,o=0,i=[];++r<n;){var a=t[r];e(a,r,t)&&(i[o++]=a)}return i}(Vt(t),(function(e){return Bt.call(t,e)})))}:kt;function Nt(t,e){for(var r=-1,n=e.length,o=t.length;++r<n;)t[o+r]=e[r];return t}var Ft=wt(Object.getPrototypeOf,Object),Dt=Object.getOwnPropertySymbols?function(t){for(var e=[];t;)Nt(e,Lt(t)),t=Ft(t);return e}:kt;function $t(t,e,r){var n=e(t);return rt(t)?n:Nt(n,r(t))}function Ht(t){return $t(t,St,Lt)}function Wt(t){return $t(t,Tt,Dt)}var qt=k(c,"DataView"),Gt=k(c,"Promise"),Qt=k(c,"Set"),Xt=k(c,"WeakMap"),Yt="[object Map]",Jt="[object Promise]",Zt="[object Set]",Kt="[object WeakMap]",te="[object DataView]",ee=S(qt),re=S(B),ne=S(Gt),oe=S(Qt),ie=S(Xt),ae=y;(qt&&ae(new qt(new ArrayBuffer(1)))!=te||B&&ae(new B)!=Yt||Gt&&ae(Gt.resolve())!=Jt||Qt&&ae(new Qt)!=Zt||Xt&&ae(new Xt)!=Kt)&&(ae=function(t){var e=y(t),r="[object Object]"==e?t.constructor:void 0,n=r?S(r):"";if(n)switch(n){case ee:return te;case re:return Yt;case ne:return Jt;case oe:return Zt;case ie:return Kt}return e});var ce=ae,se=Object.prototype.hasOwnProperty;var ue=c.Uint8Array;function le(t){var e=new t.constructor(t.byteLength);return new ue(e).set(new ue(t)),e}var fe=/\w*$/;var pe=s?s.prototype:void 0,he=pe?pe.valueOf:void 0;var ve="[object Boolean]",be="[object Date]",de="[object Map]",ye="[object Number]",_e="[object RegExp]",ge="[object Set]",je="[object String]",me="[object Symbol]",Oe="[object ArrayBuffer]",xe="[object DataView]",we="[object Float32Array]",Ae="[object Float64Array]",Pe="[object Int8Array]",Ee="[object Int16Array]",Se="[object Int32Array]",Ie="[object Uint8Array]",Ce="[object Uint8ClampedArray]",Te="[object Uint16Array]",Me="[object Uint32Array]";function Ue(t,e,r){var n,o,i,a=t.constructor;switch(e){case Oe:return le(t);case ve:case be:return new a(+t);case xe:return function(t,e){var r=e?le(t.buffer):t.buffer;return new t.constructor(r,t.byteOffset,t.byteLength)}(t,r);case we:case Ae:case Pe:case Ee:case Se:case Ie:case Ce:case Te:case Me:return function(t,e){var r=e?le(t.buffer):t.buffer;return new t.constructor(r,t.byteOffset,t.length)}(t,r);case de:return new a;case ye:case je:return new a(t);case _e:return(i=new(o=t).constructor(o.source,fe.exec(o))).lastIndex=o.lastIndex,i;case ge:return new a;case me:return n=t,he?Object(he.call(n)):{}}}var Re=Object.create,ze=function(){function t(){}return function(e){if(!_(e))return{};if(Re)return Re(e);t.prototype=e;var r=new t;return t.prototype=void 0,r}}();var ke=yt&&yt.isMap,Be=ke?ht(ke):function(t){return Y(t)&&"[object Map]"==ce(t)};var Ve=yt&&yt.isSet,Le=Ve?ht(Ve):function(t){return Y(t)&&"[object Set]"==ce(t)},Ne=1,Fe=2,De=4,$e="[object Arguments]",He="[object Function]",We="[object GeneratorFunction]",qe="[object Object]",Ge={};function Qe(t,e,r,n,o,i){var a,c=e&Ne,s=e&Fe,u=e&De;if(r&&(a=o?r(t,n,o,i):r(t)),void 0!==a)return a;if(!_(t))return t;var l=rt(t);if(l){if(a=function(t){var e=t.length,r=new t.constructor(e);return e&&"string"==typeof t[0]&&se.call(t,"index")&&(r.index=t.index,r.input=t.input),r}(t),!c)return function(t,e){var r=-1,n=t.length;for(e||(e=Array(n));++r<n;)e[r]=t[r];return e}(t,a)}else{var f=ce(t),p=f==He||f==We;if(at(t))return function(t,e){if(e)return t.slice();var r=t.length,n=zt?zt(r):new t.constructor(r);return t.copy(n),n}(t,c);if(f==qe||f==$e||p&&!o){if(a=s||p?{}:function(t){return"function"!=typeof t.constructor||xt(t)?{}:ze(Ft(t))}(t),!c)return s?function(t,e){return X(t,Dt(t),e)}(t,function(t,e){return t&&X(e,Tt(e),t)}(a,t)):function(t,e){return X(t,Lt(t),e)}(t,function(t,e){return t&&X(e,St(e),t)}(a,t))}else{if(!Ge[f])return o?t:{};a=Ue(t,f,c)}}i||(i=new H);var h=i.get(t);if(h)return h;i.set(t,a),Le(t)?t.forEach((function(n){a.add(Qe(n,e,r,n,t,i))})):Be(t)&&t.forEach((function(n,o){a.set(o,Qe(n,e,r,o,t,i))}));var v=l?void 0:(u?s?Wt:Ht:s?Tt:St)(t);return function(t,e){for(var r=-1,n=null==t?0:t.length;++r<n&&!1!==e(t[r],r,t););}(v||t,(function(n,o){v&&(n=t[o=n]),Q(a,o,Qe(n,e,r,o,t,i))})),a}Ge[$e]=Ge["[object Array]"]=Ge["[object ArrayBuffer]"]=Ge["[object DataView]"]=Ge["[object Boolean]"]=Ge["[object Date]"]=Ge["[object Float32Array]"]=Ge["[object Float64Array]"]=Ge["[object Int8Array]"]=Ge["[object Int16Array]"]=Ge["[object Int32Array]"]=Ge["[object Map]"]=Ge["[object Number]"]=Ge[qe]=Ge["[object RegExp]"]=Ge["[object Set]"]=Ge["[object String]"]=Ge["[object Symbol]"]=Ge["[object Uint8Array]"]=Ge["[object Uint8ClampedArray]"]=Ge["[object Uint16Array]"]=Ge["[object Uint32Array]"]=!0,Ge["[object Error]"]=Ge[He]=Ge["[object WeakMap]"]=!1;function Xe(t){return t}var Ye=Math.max;var Je=W?function(t,e){return W(t,"toString",{configurable:!0,enumerable:!1,value:(r=e,function(){return r}),writable:!0});var r}:Xe,Ze=Je,Ke=Date.now;var tr,er,rr,nr=(tr=Ze,er=0,rr=0,function(){var t=Ke(),e=16-(t-rr);if(rr=t,e>0){if(++er>=800)return arguments[0]}else er=0;return tr.apply(void 0,arguments)});var or=Object.prototype,ir=or.hasOwnProperty,ar=function(t,e){return nr(function(t,e,r){return e=Ye(void 0===e?t.length-1:e,0),function(){for(var n=arguments,o=-1,i=Ye(n.length-e,0),a=Array(i);++o<i;)a[o]=n[e+o];o=-1;for(var c=Array(e+1);++o<e;)c[o]=n[o];return c[e]=r(a),function(t,e,r){switch(r.length){case 0:return t.call(e);case 1:return t.call(e,r[0]);case 2:return t.call(e,r[0],r[1]);case 3:return t.call(e,r[0],r[1],r[2])}return t.apply(e,r)}(t,this,c)}}(t,e,Xe),t+"")}((function(t,r){t=Object(t);var n=-1,o=r.length,i=o>2?r[2]:void 0;for(i&&function(t,r,n){if(!_(n))return!1;var o=typeof r;return!!("number"==o?Et(n)&&ut(r,n.length):"string"==o&&r in n)&&e(n[r],t)}(r[0],r[1],i)&&(o=1);++n<o;)for(var a=r[n],c=Tt(a),s=-1,u=c.length;++s<u;){var l=c[s],f=t[l];(void 0===f||e(f,or[l])&&!ir.call(t,l))&&(t[l]=a[l])}return t})),cr=/\s/;var sr=/^\s+/;function ur(t){return t?t.slice(0,function(t){for(var e=t.length;e--&&cr.test(t.charAt(e)););return e}(t)+1).replace(sr,""):t}var lr="[object Symbol]";function fr(t){return"symbol"==typeof t||Y(t)&&y(t)==lr}var pr=NaN,hr=/^[-+]0x[0-9a-f]+$/i,vr=/^0b[01]+$/i,br=/^0o[0-7]+$/i,dr=parseInt;function yr(t){if("number"==typeof t)return t;if(fr(t))return pr;if(_(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=_(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=ur(t);var r=vr.test(t);return r||br.test(t)?dr(t.slice(2),r?2:8):hr.test(t)?pr:+t}var _r=1/0,gr=17976931348623157e292;function jr(t){var e=function(t){return t?(t=yr(t))===_r||t===-_r?(t<0?-1:1)*gr:t==t?t:0:0===t?t:0}(t),r=e%1;return e==e?r?e-r:e:0}var mr=1/0,Or=s?s.prototype:void 0,xr=Or?Or.toString:void 0;function wr(t){if("string"==typeof t)return t;if(rt(t))return function(t,e){for(var r=-1,n=null==t?0:t.length,o=Array(n);++r<n;)o[r]=e(t[r],r,t);return o}(t,wr)+"";if(fr(t))return xr?xr.call(t):"";var e=t+"";return"0"==e&&1/t==-mr?"-0":e}function Ar(t){return null==t?"":wr(t)}var Pr=c.isFinite,Er=Math.min;var Sr=function(t){var e=Math[t];return function(t,r){if(t=yr(t),(r=null==r?0:Er(jr(r),292))&&Pr(t)){var n=(Ar(t)+"e").split("e");return+((n=(Ar(e(n[0]+"e"+(+n[1]+r)))+"e").split("e"))[0]+"e"+(+n[1]-r))}return e(t)}}("round");const Ir=(e=!0)=>{const r=new t.fabric.Circle({strokeWidth:4,radius:6,fill:"#ffffff",stroke:"#4b4b4b",originX:"center",originY:"center"});return r.on("mouseover",(()=>{var t;r.set({fill:"#7ef4ad"}),null===(t=r.canvas)||void 0===t||t.renderAll()})),r.on("mouseout",(()=>{var t,e;r.set({fill:(null===(t=r.canvas)||void 0===t?void 0:t.getActiveObject())===r?"#29ca6e":"#ffffff"}),null===(e=r.canvas)||void 0===e||e.renderAll()})),r.on("selected",(()=>{var t;r.set({fill:"#29ca6e"}),null===(t=r.canvas)||void 0===t||t.renderAll()})),r.on("deselected",(()=>{var t;r.set({fill:"#ffffff"}),null===(t=r.canvas)||void 0===t||t.renderAll()})),e||r.set({opacity:.2}),r},Cr=()=>{const e=new t.fabric.Circle({radius:5,fill:"#bebebe",originX:"center",originY:"center"});return e.on("mouseover",(()=>{var t;e.set({strokeWidth:4,radius:4,fill:"#ffffff",stroke:"#4b4b4b"}),null===(t=e.canvas)||void 0===t||t.renderAll()})),e.on("mouseout",(()=>{var t;e.set({strokeWidth:0,radius:5,fill:"#bebebe",stroke:"transparent"}),null===(t=e.canvas)||void 0===t||t.renderAll()})),e},Tr=Symbol("fabric-path-editor-symbol"),Mr=Symbol("fabric-path-editor-controller-info");var Ur,Rr;!function(t){t.MAJOR_POINT="major-point",t.SUB_POINT="sub-point"}(Ur||(Ur={})),function(t){t.START="M",t.LINE="L",t.QUADRATIC_CURCE="Q",t.BEZIER_CURVE="C",t.CLOSE="z"}(Rr||(Rr={}));class zr{constructor(t,e={}){this._options={},this.source=null,this.target=null,this.controllers={points:[]},this.listeners=[],this._storePlatformStatus=null,this._platform=t,this._options=ar(e,this._options)}observe(t){this.source=t}static transformPath(t,e,r=!0){const{translate:n,scale:o,rotate:i}=e,a=r?t.path:Qe(t.path,5);return null==a||a.forEach(((t,e)=>{const[,...r]=t;for(let t=0;t<r.length;t+=2){let r=a[e][t+1],c=a[e][t+2];void 0!==o&&(r*=o.x,c*=o.y),void 0!==i&&(r=Math.cos(i*Math.PI/180)*r-Math.sin(i*Math.PI/180)*c,c=Math.sin(i*Math.PI/180)*r+Math.cos(i*Math.PI/180)*c),void 0!==n&&(r+=n.x,c+=n.y),a[e][t+1]=r,a[e][t+2]=c}})),a}static initializePath(e,r,n=[1,0,0,1,0,0]){var o;const i=e.left,a=e.top;null===(o=e.path)||void 0===o||o.forEach((t=>{const[,...e]=t;for(let r=0;r<e.length;r+=2)t[r+1]=Sr(t[r+1],3),t[r+2]=Sr(t[r+2],3)}));const c=new t.fabric.Path(t.fabric.util.joinPath(e.path)).getCenterPoint();e.initialize(r);const s=new t.fabric.Path(r).getCenterPoint(),u=t.fabric.util.transformPoint(new t.fabric.Point(s.x-c.x,s.y-c.y),n);e.set({left:i+u.x,top:a+u.y}),e.setCoords()}_patchPath(e){if(!e.path)return;const r=e.path;zr.transformPath(e,{translate:{x:-e.pathOffset.x,y:-e.pathOffset.y}});if(r[r.length-1][0]===Rr.CLOSE){const t=r[0].slice(r[0].length-2),e=r[r.length-2].slice(r[r.length-2].length-2);e[0]===t[0]&&e[1]===t[1]||r.splice(r.length-1,0,[Rr.LINE,t[0],t[1]])}e.pathOffset=new t.fabric.Point(0,0)}_initPlatformStatus(){var t;if(!this._platform)return;const e=this._platform;this._storePlatformStatus={canvasSelection:null!==(t=e.selection)&&void 0!==t&&t,objectSelections:new WeakMap(e._objects.map((t=>{var e;return[t,null===(e=t.selectable)||void 0===e||e]})))},e.selection=!1,e.discardActiveObject(),e.forEachObject((t=>{t.set({selectable:!1})}))}_getPointInstructions(t){var e,r;const n=t[Mr].instruction,o=null===(e=this.target)||void 0===e?void 0:e.path;if(!o)return{cur:null,next:null,pre:null};const i=o.indexOf(n);let a=o[i-1],c=o[i+1];return(null===(r=o[o.length-1])||void 0===r?void 0:r[0])===Rr.CLOSE&&!a&&(a=o[o.length-2]),c&&c[0]===Rr.CLOSE&&(c=o[0]),{cur:n,pre:null!=a?a:null,next:null!=c?c:null}}_getPointAroundPoints(t){const{cur:e,pre:r,next:n}=this._getPointInstructions(t);if(!e)return{cur:null,pre:null,next:null};let o=null,i=null;switch(e[0]){case Rr.START:(null==r?void 0:r[0])===Rr.QUADRATIC_CURCE&&(o={instruction:r,instructionValueIdx:r.length-2,point:{x:r[r.length-2],y:r[r.length-1]}}),(null==r?void 0:r[0])===Rr.BEZIER_CURVE&&(o={instruction:r,instructionValueIdx:r.length-4,point:{x:r[r.length-4],y:r[r.length-3]}});break;case Rr.LINE:r&&(o={instruction:r,instructionValueIdx:r.length-2,point:{x:r[r.length-2],y:r[r.length-1]}});break;case Rr.QUADRATIC_CURCE:o={instruction:e,instructionValueIdx:1,point:{x:e[1],y:e[2]}};break;case Rr.BEZIER_CURVE:o={instruction:e,instructionValueIdx:3,point:{x:e[3],y:e[4]}};case Rr.CLOSE:}return n&&n[0]!==Rr.CLOSE&&(i={instruction:n,instructionValueIdx:1,point:{x:n[1],y:n[2]}}),{cur:{instruction:e,instructionValueIdx:e.length-2,point:{x:e[e.length-2],y:e[e.length-1]}},pre:o,next:i}}_getCroodBetweenTwoCroods(t,e,r){const n=e.x-t.x,o=e.y-t.y,i=Math.sqrt(o**2+n**2),a=r?r/i:.5;return{x:t.x+n*a,y:t.y+o*a}}_withSourceTransform(e){const r=t.fabric.util.transformPoint(new t.fabric.Point(e.x,e.y),this.source.calcOwnMatrix());return{left:r.x,top:r.y}}_invertSourceTransform(e){const r=t.fabric.util.transformPoint(new t.fabric.Point(e.x,e.y),t.fabric.util.invertTransform(this.source.calcOwnMatrix()));return{left:r.x,top:r.y}}_addControlPointEvents(t){const e=this._platform;t.on("selected",(()=>{t.item(0).set({fill:"#29ca6e"});const{cur:r,pre:n,next:o}=this._getPointAroundPoints(t),{preHandler:i,nextHandler:a}=this.controllers;[{target:i,instruction:n,hidden:!(null==n?void 0:n.point)||!r||r.instruction[0]===Rr.LINE},{target:a,instruction:o,hidden:!(null==o?void 0:o.point)||o.instruction[0]===Rr.LINE}].forEach((({target:r,instruction:n,hidden:o})=>{if(!r)return;if(o)return void this._observe(r.point,(()=>{}));if(!(null==n?void 0:n.point))return;const i=this._withSourceTransform(n.point);r.point[Mr].instruction=n.instruction,r.point[Mr].instructionValueIdx=n.instructionValueIdx,this._observe(r.point,((e,o)=>{r.line.set({x1:t.left,y1:t.top,x2:r.point.left,y2:r.point.top}),"left"===e&&(n.instruction[n.instructionValueIdx]=o),"top"===e&&(n.instruction[n.instructionValueIdx+1]=o)})),r.point.set(i),e.add(r.line,r.point)})),e.renderAll()})),t.on("deselected",(()=>{t.item(0).set({fill:"#ffffff"});const{preHandler:r,nextHandler:n}=this.controllers;r&&(e.remove(r.point),e.remove(r.line)),n&&(e.remove(n.point),e.remove(n.line))}))}_initPathControlPoints(){const e=this._platform,r=this.target;if(!e||!r)return;const n=[],o=r.path;null==o||o.forEach(((e,r)=>{var i;const a=e;if(a[0]===Rr.CLOSE)return;if((null===(i=o[r+1])||void 0===i?void 0:i[0])===Rr.CLOSE)return;const[c,s]=a.slice(a.length-2),u=new t.fabric.Group([Ir()],{originX:"center",originY:"center",hasBorders:!1,hasControls:!1});u[Tr]=!0,u[Mr]={type:Ur.MAJOR_POINT,instruction:a,instructionValueIdx:a.length-2},this._observe(u,((t,e)=>{const{pre:r}=this._getPointInstructions(u),{preHandler:n,nextHandler:o}=this.controllers;if("left"===t){const t=e-a[a.length-2];n&&n.point.set({left:n.point.left+t}),o&&o.point.set({left:o.point.left+t}),a[a.length-2]=e,a[0]===Rr.START&&r&&(r[r.length-2]=e)}if("top"===t){const t=e-a[a.length-1];n&&n.point.set({top:n.point.top+t}),o&&o.point.set({top:o.point.top+t}),a[a.length-1]=e,a[0]===Rr.START&&r&&(r[r.length-1]=e)}})),u.set(this._withSourceTransform({x:c,y:s})),this._addControlPointEvents(u),n.push(u)})),e.add(...n),this.controllers.points=n}_initPathControlHandlers(){return["pre","next"].forEach((e=>{const r=new t.fabric.Group([Cr()],{originX:"center",originY:"center",hasBorders:!1,hasControls:!1});r[Tr]=!0,r[Mr]={type:Ur.SUB_POINT};const n=new t.fabric.Line([0,0,0,0],{stroke:"#bebebe",strokeWidth:1,strokeDashArray:[4,3],strokeUniform:!0,selectable:!1,evented:!1});this.controllers[`${e}Handler`]={point:r,line:n}})),this.controllers}_observe(t,e){var r,n;let o=null!==(r=t.left)&&void 0!==r?r:0,i=null!==(n=t.top)&&void 0!==n?n:0;Object.defineProperties(t,{left:{get:()=>o,set:t=>{o=t;const r=this._invertSourceTransform({x:o,y:0});e("left",r.left)}},top:{get:()=>i,set:t=>{i=t;const r=this._invertSourceTransform({x:0,y:i});e("top",r.top)}}})}_handleCanvasObjectMove({target:t}){const e=t[Mr];if(!e)return;const{type:r,instruction:n,instructionValueIdx:o}=e;if(n&&o)switch(r){case Ur.MAJOR_POINT:case Ur.SUB_POINT:}}_on(t,e,r){"global"===t&&window.addEventListener(e,r),"canvas"===t&&this._platform.on(e,r),this.listeners.push({type:t,eventName:e,handler:r})}_off(t,e,r){let n=0;for(;n<this.listeners.length;){const o=this.listeners[n];o.eventName===e?r&&o.handler!==r?n++:("global"===t&&window.removeEventListener(e,r),"canvas"===t&&this._platform.off(e,r),this.listeners.splice(n,1)):n++}}_initPointOperateEvents(){this._on("canvas","object:moving",this._handleCanvasObjectMove.bind(this))}async enterEditing(t){if(!this.source||"path"!==this.source.type)throw Error("Please observe target path before editing.");this._initPlatformStatus(),this.target=await new Promise((t=>this.source.clone(t))),this._patchPath(this.target),t&&t(this.target),this.target[Tr]=!0,this.target.set({selectable:!1,objectCaching:!1}),this._platform.add(this.target),this._platform.renderOnAddRemove=!1,this._initPathControlPoints(),this._initPathControlHandlers(),this._platform.renderOnAddRemove=!0,this._platform.renderAll(),this._initPointOperateEvents(),this._platform.setActiveObject(this.controllers.points[0])}leaveEditing(){}destory(){}}return zr}));
