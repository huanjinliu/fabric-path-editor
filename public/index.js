!function(t,e){t&&!t.getElementById("livereloadscript")&&((e=t.createElement("script")).async=1,e.src="//"+(self.location.host||"localhost").split(":")[0]+":35729/livereload.js?snipver=1",e.id="livereloadscript",t.getElementsByTagName("head")[0].appendChild(e))}(self.document),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("fabric")):"function"==typeof define&&define.amd?define(["fabric"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).FabricPathEditor=e(t.fabric)}(this,(function(e){"use strict";const{abs:n,cos:r,sin:i,acos:o,atan2:s,sqrt:c,pow:a}=Math;function l(t){return t<0?-a(-t,1/3):a(t,1/3)}const u=Math.PI,h=2*u,f=u/2,p=Number.MAX_SAFE_INTEGER||9007199254740991,d=Number.MIN_SAFE_INTEGER||-9007199254740991,y={x:0,y:0,z:0},v={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(t,e){const n=e(t);let r=n.x*n.x+n.y*n.y;return void 0!==n.z&&(r+=n.z*n.z),c(r)},compute:function(t,e,n){if(0===t)return e[0].t=0,e[0];const r=e.length-1;if(1===t)return e[r].t=1,e[r];const i=1-t;let o=e;if(0===r)return e[0].t=t,e[0];if(1===r){const e={x:i*o[0].x+t*o[1].x,y:i*o[0].y+t*o[1].y,t:t};return n&&(e.z=i*o[0].z+t*o[1].z),e}if(r<4){let e,s,c,a=i*i,l=t*t,u=0;2===r?(o=[o[0],o[1],o[2],y],e=a,s=i*t*2,c=l):3===r&&(e=a*i,s=a*t*3,c=i*l*3,u=t*l);const h={x:e*o[0].x+s*o[1].x+c*o[2].x+u*o[3].x,y:e*o[0].y+s*o[1].y+c*o[2].y+u*o[3].y,t:t};return n&&(h.z=e*o[0].z+s*o[1].z+c*o[2].z+u*o[3].z),h}const s=JSON.parse(JSON.stringify(e));for(;s.length>1;){for(let e=0;e<s.length-1;e++)s[e]={x:s[e].x+(s[e+1].x-s[e].x)*t,y:s[e].y+(s[e+1].y-s[e].y)*t},void 0!==s[e].z&&(s[e].z=s[e].z+(s[e+1].z-s[e].z)*t);s.splice(s.length-1,1)}return s[0].t=t,s[0]},computeWithRatios:function(t,e,n,r){const i=1-t,o=n,s=e;let c,a=o[0],l=o[1],u=o[2],h=o[3];return a*=i,l*=t,2===s.length?(c=a+l,{x:(a*s[0].x+l*s[1].x)/c,y:(a*s[0].y+l*s[1].y)/c,z:!!r&&(a*s[0].z+l*s[1].z)/c,t:t}):(a*=i,l*=2*i,u*=t*t,3===s.length?(c=a+l+u,{x:(a*s[0].x+l*s[1].x+u*s[2].x)/c,y:(a*s[0].y+l*s[1].y+u*s[2].y)/c,z:!!r&&(a*s[0].z+l*s[1].z+u*s[2].z)/c,t:t}):(a*=i,l*=1.5*i,u*=3*i,h*=t*t*t,4===s.length?(c=a+l+u+h,{x:(a*s[0].x+l*s[1].x+u*s[2].x+h*s[3].x)/c,y:(a*s[0].y+l*s[1].y+u*s[2].y+h*s[3].y)/c,z:!!r&&(a*s[0].z+l*s[1].z+u*s[2].z+h*s[3].z)/c,t:t}):void 0))},derive:function(t,e){const n=[];for(let r=t,i=r.length,o=i-1;i>1;i--,o--){const t=[];for(let n,i=0;i<o;i++)n={x:o*(r[i+1].x-r[i].x),y:o*(r[i+1].y-r[i].y)},e&&(n.z=o*(r[i+1].z-r[i].z)),t.push(n);n.push(t),r=t}return n},between:function(t,e,n){return e<=t&&t<=n||v.approximately(t,e)||v.approximately(t,n)},approximately:function(t,e,r){return n(t-e)<=(r||1e-6)},length:function(t){const e=v.Tvalues.length;let n=0;for(let r,i=0;i<e;i++)r=.5*v.Tvalues[i]+.5,n+=v.Cvalues[i]*v.arcfn(r,t);return.5*n},map:function(t,e,n,r,i){return r+(i-r)*((t-e)/(n-e))},lerp:function(t,e,n){const r={x:e.x+t*(n.x-e.x),y:e.y+t*(n.y-e.y)};return void 0!==e.z&&void 0!==n.z&&(r.z=e.z+t*(n.z-e.z)),r},pointToString:function(t){let e=t.x+"/"+t.y;return void 0!==t.z&&(e+="/"+t.z),e},pointsToString:function(t){return"["+t.map(v.pointToString).join(", ")+"]"},copy:function(t){return JSON.parse(JSON.stringify(t))},angle:function(t,e,n){const r=e.x-t.x,i=e.y-t.y,o=n.x-t.x,c=n.y-t.y;return s(r*c-i*o,r*o+i*c)},round:function(t,e){const n=""+t,r=n.indexOf(".");return parseFloat(n.substring(0,r+1+e))},dist:function(t,e){const n=t.x-e.x,r=t.y-e.y;return c(n*n+r*r)},closest:function(t,e){let n,r,i=a(2,63);return t.forEach((function(t,o){r=v.dist(e,t),r<i&&(i=r,n=o)})),{mdist:i,mpos:n}},abcratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const r=a(t,e)+a(1-t,e);return n((r-1)/r)},projectionratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const n=a(1-t,e);return n/(a(t,e)+n)},lli8:function(t,e,n,r,i,o,s,c){const a=(t-n)*(o-c)-(e-r)*(i-s);return 0!=a&&{x:((t*r-e*n)*(i-s)-(t-n)*(i*c-o*s))/a,y:((t*r-e*n)*(o-c)-(e-r)*(i*c-o*s))/a}},lli4:function(t,e,n,r){const i=t.x,o=t.y,s=e.x,c=e.y,a=n.x,l=n.y,u=r.x,h=r.y;return v.lli8(i,o,s,c,a,l,u,h)},lli:function(t,e){return v.lli4(t,t.c,e,e.c)},makeline:function(t,e){return new O(t.x,t.y,(t.x+e.x)/2,(t.y+e.y)/2,e.x,e.y)},findbbox:function(t){let e=p,n=p,r=d,i=d;return t.forEach((function(t){const o=t.bbox();e>o.x.min&&(e=o.x.min),n>o.y.min&&(n=o.y.min),r<o.x.max&&(r=o.x.max),i<o.y.max&&(i=o.y.max)})),{x:{min:e,mid:(e+r)/2,max:r,size:r-e},y:{min:n,mid:(n+i)/2,max:i,size:i-n}}},shapeintersections:function(t,e,n,r,i){if(!v.bboxoverlap(e,r))return[];const o=[],s=[t.startcap,t.forward,t.back,t.endcap],c=[n.startcap,n.forward,n.back,n.endcap];return s.forEach((function(e){e.virtual||c.forEach((function(r){if(r.virtual)return;const s=e.intersects(r,i);s.length>0&&(s.c1=e,s.c2=r,s.s1=t,s.s2=n,o.push(s))}))})),o},makeshape:function(t,e,n){const r=e.points.length,i=t.points.length,o=v.makeline(e.points[r-1],t.points[0]),s=v.makeline(t.points[i-1],e.points[0]),c={startcap:o,forward:t,back:e,endcap:s,bbox:v.findbbox([o,t,e,s]),intersections:function(t){return v.shapeintersections(c,c.bbox,t,t.bbox,n)}};return c},getminmax:function(t,e,n){if(!n)return{min:0,max:0};let r,i,o=p,s=d;-1===n.indexOf(0)&&(n=[0].concat(n)),-1===n.indexOf(1)&&n.push(1);for(let c=0,a=n.length;c<a;c++)r=n[c],i=t.get(r),i[e]<o&&(o=i[e]),i[e]>s&&(s=i[e]);return{min:o,mid:(o+s)/2,max:s,size:s-o}},align:function(t,e){const n=e.p1.x,o=e.p1.y,c=-s(e.p2.y-o,e.p2.x-n);return t.map((function(t){return{x:(t.x-n)*r(c)-(t.y-o)*i(c),y:(t.x-n)*i(c)+(t.y-o)*r(c)}}))},roots:function(t,e){e=e||{p1:{x:0,y:0},p2:{x:1,y:0}};const n=t.length-1,i=v.align(t,e),s=function(t){return 0<=t&&t<=1};if(2===n){const t=i[0].y,e=i[1].y,n=i[2].y,r=t-2*e+n;if(0!==r){const i=-c(e*e-t*n),o=-t+e;return[-(i+o)/r,-(-i+o)/r].filter(s)}return e!==n&&0===r?[(2*e-n)/(2*e-2*n)].filter(s):[]}const a=i[0].y,u=i[1].y,f=i[2].y;let p=3*u-a-3*f+i[3].y,d=3*a-6*u+3*f,y=-3*a+3*u,b=a;if(v.approximately(p,0)){if(v.approximately(d,0))return v.approximately(y,0)?[]:[-b/y].filter(s);const t=c(y*y-4*d*b),e=2*d;return[(t-y)/e,(-y-t)/e].filter(s)}d/=p,y/=p,b/=p;const g=(3*y-d*d)/3,x=g/3,_=(2*d*d*d-9*d*y+27*b)/27,m=_/2,P=m*m+x*x*x;let A,j,w,O,z;if(P<0){const t=-g/3,e=c(t*t*t),n=-_/(2*e),i=o(n<-1?-1:n>1?1:n),a=2*l(e);return w=a*r(i/3)-d/3,O=a*r((i+h)/3)-d/3,z=a*r((i+2*h)/3)-d/3,[w,O,z].filter(s)}if(0===P)return A=m<0?l(-m):-l(m),w=2*A-d/3,O=-A-d/3,[w,O].filter(s);{const t=c(P);return A=l(-m+t),j=l(m+t),[A-j-d/3].filter(s)}},droots:function(t){if(3===t.length){const e=t[0],n=t[1],r=t[2],i=e-2*n+r;if(0!==i){const t=-c(n*n-e*r),o=-e+n;return[-(t+o)/i,-(-t+o)/i]}return n!==r&&0===i?[(2*n-r)/(2*(n-r))]:[]}if(2===t.length){const e=t[0],n=t[1];return e!==n?[e/(e-n)]:[]}return[]},curvature:function(t,e,r,i,o){let s,l,u,h,f=0,p=0;const d=v.compute(t,e),y=v.compute(t,r),b=d.x*d.x+d.y*d.y;if(i?(s=c(a(d.y*y.z-y.y*d.z,2)+a(d.z*y.x-y.z*d.x,2)+a(d.x*y.y-y.x*d.y,2)),l=a(b+d.z*d.z,1.5)):(s=d.x*y.y-d.y*y.x,l=a(b,1.5)),0===s||0===l)return{k:0,r:0};if(f=s/l,p=l/s,!o){const o=v.curvature(t-.001,e,r,i,!0).k,s=v.curvature(t+.001,e,r,i,!0).k;h=(s-f+(f-o))/2,u=(n(s-f)+n(f-o))/2}return{k:f,r:p,dk:h,adk:u}},inflections:function(t){if(t.length<4)return[];const e=v.align(t,{p1:t[0],p2:t.slice(-1)[0]}),n=e[2].x*e[1].y,r=e[3].x*e[1].y,i=e[1].x*e[2].y,o=18*(-3*n+2*r+3*i-e[3].x*e[2].y),s=18*(3*n-r-3*i),c=18*(i-n);if(v.approximately(o,0)){if(!v.approximately(s,0)){let t=-c/s;if(0<=t&&t<=1)return[t]}return[]}const a=2*o;if(v.approximately(a,0))return[];const l=s*s-4*o*c;if(l<0)return[];const u=Math.sqrt(l);return[(u-s)/a,-(s+u)/a].filter((function(t){return 0<=t&&t<=1}))},bboxoverlap:function(t,e){const r=["x","y"],i=r.length;for(let o,s,c,a,l=0;l<i;l++)if(o=r[l],s=t[o].mid,c=e[o].mid,a=(t[o].size+e[o].size)/2,n(s-c)>=a)return!1;return!0},expandbox:function(t,e){e.x.min<t.x.min&&(t.x.min=e.x.min),e.y.min<t.y.min&&(t.y.min=e.y.min),e.z&&e.z.min<t.z.min&&(t.z.min=e.z.min),e.x.max>t.x.max&&(t.x.max=e.x.max),e.y.max>t.y.max&&(t.y.max=e.y.max),e.z&&e.z.max>t.z.max&&(t.z.max=e.z.max),t.x.mid=(t.x.min+t.x.max)/2,t.y.mid=(t.y.min+t.y.max)/2,t.z&&(t.z.mid=(t.z.min+t.z.max)/2),t.x.size=t.x.max-t.x.min,t.y.size=t.y.max-t.y.min,t.z&&(t.z.size=t.z.max-t.z.min)},pairiteration:function(t,e,n){const r=t.bbox(),i=e.bbox(),o=1e5,s=n||.5;if(r.x.size+r.y.size<s&&i.x.size+i.y.size<s)return[(o*(t._t1+t._t2)/2|0)/o+"/"+(o*(e._t1+e._t2)/2|0)/o];let c=t.split(.5),a=e.split(.5),l=[{left:c.left,right:a.left},{left:c.left,right:a.right},{left:c.right,right:a.right},{left:c.right,right:a.left}];l=l.filter((function(t){return v.bboxoverlap(t.left.bbox(),t.right.bbox())}));let u=[];return 0===l.length||(l.forEach((function(t){u=u.concat(v.pairiteration(t.left,t.right,s))})),u=u.filter((function(t,e){return u.indexOf(t)===e}))),u},getccenter:function(t,e,n){const o=e.x-t.x,c=e.y-t.y,a=n.x-e.x,l=n.y-e.y,u=o*r(f)-c*i(f),p=o*i(f)+c*r(f),d=a*r(f)-l*i(f),y=a*i(f)+l*r(f),b=(t.x+e.x)/2,g=(t.y+e.y)/2,x=(e.x+n.x)/2,_=(e.y+n.y)/2,m=b+u,P=g+p,A=x+d,j=_+y,w=v.lli8(b,g,m,P,x,_,A,j),O=v.dist(w,t);let z,E=s(t.y-w.y,t.x-w.x),S=s(e.y-w.y,e.x-w.x),C=s(n.y-w.y,n.x-w.x);return E<C?((E>S||S>C)&&(E+=h),E>C&&(z=C,C=E,E=z)):C<S&&S<E?(z=C,C=E,E=z):C+=h,w.s=E,w.e=C,w.r=O,w},numberSort:function(t,e){return t-e}};class b{constructor(t){this.curves=[],this._3d=!1,t&&(this.curves=t,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map((function(t){return v.pointsToString(t.points)})).join(", ")+"]"}addCurve(t){this.curves.push(t),this._3d=this._3d||t._3d}length(){return this.curves.map((function(t){return t.length()})).reduce((function(t,e){return t+e}))}curve(t){return this.curves[t]}bbox(){const t=this.curves;for(var e=t[0].bbox(),n=1;n<t.length;n++)v.expandbox(e,t[n].bbox());return e}offset(t){const e=[];return this.curves.forEach((function(n){e.push(...n.offset(t))})),new b(e)}}const{abs:g,min:x,max:_,cos:m,sin:P,acos:A,sqrt:j}=Math,w=Math.PI;class O{constructor(t){let e=t&&t.forEach?t:Array.from(arguments).slice(),n=!1;if("object"==typeof e[0]){n=e.length;const t=[];e.forEach((function(e){["x","y","z"].forEach((function(n){void 0!==e[n]&&t.push(e[n])}))})),e=t}let r=!1;const i=e.length;if(n){if(n>4){if(1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");r=!0}}else if(6!==i&&8!==i&&9!==i&&12!==i&&1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const o=this._3d=!r&&(9===i||12===i)||t&&t[0]&&void 0!==t[0].z,s=this.points=[];for(let t=0,n=o?3:2;t<i;t+=n){var c={x:e[t],y:e[t+1]};o&&(c.z=e[t+2]),s.push(c)}const a=this.order=s.length-1,l=this.dims=["x","y"];o&&l.push("z"),this.dimlen=l.length;const u=v.align(s,{p1:s[0],p2:s[a]}),h=v.dist(s[0],s[a]);this._linear=u.reduce(((t,e)=>t+g(e.y)),0)<h/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(t,e,n,r){if(void 0===r&&(r=.5),0===r)return new O(e,e,n);if(1===r)return new O(t,e,e);const i=O.getABC(2,t,e,n,r);return new O(t,i.A,n)}static cubicFromPoints(t,e,n,r,i){void 0===r&&(r=.5);const o=O.getABC(3,t,e,n,r);void 0===i&&(i=v.dist(e,o.C));const s=i*(1-r)/r,c=v.dist(t,n),a=(n.x-t.x)/c,l=(n.y-t.y)/c,u=i*a,h=i*l,f=s*a,p=s*l,d=e.x-u,y=e.y-h,b=e.x+f,g=e.y+p,x=o.A,_=x.x+(d-x.x)/(1-r),m=x.y+(y-x.y)/(1-r),P=x.x+(b-x.x)/r,A=x.y+(g-x.y)/r,j={x:t.x+(_-t.x)/r,y:t.y+(m-t.y)/r},w={x:n.x+(P-n.x)/(1-r),y:n.y+(A-n.y)/(1-r)};return new O(t,j,w,n)}static getUtils(){return v}getUtils(){return O.getUtils()}static get PolyBezier(){return b}valueOf(){return this.toString()}toString(){return v.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const t=this.points,e=["M",t[0].x,t[0].y,2===this.order?"Q":"C"];for(let n=1,r=t.length;n<r;n++)e.push(t[n].x),e.push(t[n].y);return e.join(" ")}setRatios(t){if(t.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=t,this._lut=[]}verify(){const t=this.coordDigest();t!==this._print&&(this._print=t,this.update())}coordDigest(){return this.points.map((function(t,e){return""+e+t.x+t.y+(t.z?t.z:0)})).join("")}update(){this._lut=[],this.dpoints=v.derive(this.points,this._3d),this.computedirection()}computedirection(){const t=this.points,e=v.angle(t[0],t[this.order],t[1]);this.clockwise=e>0}length(){return v.length(this.derivative.bind(this))}static getABC(t=2,e,n,r,i=.5){const o=v.projectionratio(i,t),s=1-o,c={x:o*e.x+s*r.x,y:o*e.y+s*r.y},a=v.abcratio(i,t);return{A:{x:n.x+(n.x-c.x)/a,y:n.y+(n.y-c.y)/a},B:n,C:c,S:e,E:r}}getABC(t,e){e=e||this.get(t);let n=this.points[0],r=this.points[this.order];return O.getABC(this.order,n,e,r,t)}getLUT(t){if(this.verify(),t=t||100,this._lut.length===t+1)return this._lut;this._lut=[],t++,this._lut=[];for(let e,n,r=0;r<t;r++)n=r/(t-1),e=this.compute(n),e.t=n,this._lut.push(e);return this._lut}on(e,n){n=n||5;const r=this.getLUT(),i=[];for(let t,o=0,s=0;o<r.length;o++)t=r[o],v.dist(t,e)<n&&(i.push(t),s+=o/r.length);return!!i.length&&(t/=i.length)}project(t){const e=this.getLUT(),n=e.length-1,r=v.closest(e,t),i=r.mpos,o=(i-1)/n,s=(i+1)/n,c=.1/n;let a,l=r.mdist,u=o,h=u;l+=1;for(let e;u<s+c;u+=c)a=this.compute(u),e=v.dist(t,a),e<l&&(l=e,h=u);return h=h<0?0:h>1?1:h,a=this.compute(h),a.t=h,a.d=l,a}get(t){return this.compute(t)}point(t){return this.points[t]}compute(t){return this.ratios?v.computeWithRatios(t,this.points,this.ratios,this._3d):v.compute(t,this.points,this._3d,this.ratios)}raise(){const t=this.points,e=[t[0]],n=t.length;for(let r,i,o=1;o<n;o++)r=t[o],i=t[o-1],e[o]={x:(n-o)/n*r.x+o/n*i.x,y:(n-o)/n*r.y+o/n*i.y};return e[n]=t[n-1],new O(e)}derivative(t){return v.compute(t,this.dpoints[0],this._3d)}dderivative(t){return v.compute(t,this.dpoints[1],this._3d)}align(){let t=this.points;return new O(v.align(t,{p1:t[0],p2:t[t.length-1]}))}curvature(t){return v.curvature(t,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return v.inflections(this.points)}normal(t){return this._3d?this.__normal3(t):this.__normal2(t)}__normal2(t){const e=this.derivative(t),n=j(e.x*e.x+e.y*e.y);return{t:t,x:-e.y/n,y:e.x/n}}__normal3(t){const e=this.derivative(t),n=this.derivative(t+.01),r=j(e.x*e.x+e.y*e.y+e.z*e.z),i=j(n.x*n.x+n.y*n.y+n.z*n.z);e.x/=r,e.y/=r,e.z/=r,n.x/=i,n.y/=i,n.z/=i;const o={x:n.y*e.z-n.z*e.y,y:n.z*e.x-n.x*e.z,z:n.x*e.y-n.y*e.x},s=j(o.x*o.x+o.y*o.y+o.z*o.z);o.x/=s,o.y/=s,o.z/=s;const c=[o.x*o.x,o.x*o.y-o.z,o.x*o.z+o.y,o.x*o.y+o.z,o.y*o.y,o.y*o.z-o.x,o.x*o.z-o.y,o.y*o.z+o.x,o.z*o.z];return{t:t,x:c[0]*e.x+c[1]*e.y+c[2]*e.z,y:c[3]*e.x+c[4]*e.y+c[5]*e.z,z:c[6]*e.x+c[7]*e.y+c[8]*e.z}}hull(t){let e=this.points,n=[],r=[],i=0;for(r[i++]=e[0],r[i++]=e[1],r[i++]=e[2],3===this.order&&(r[i++]=e[3]);e.length>1;){n=[];for(let o,s=0,c=e.length-1;s<c;s++)o=v.lerp(t,e[s],e[s+1]),r[i++]=o,n.push(o);e=n}return r}split(t,e){if(0===t&&e)return this.split(e).left;if(1===e)return this.split(t).right;const n=this.hull(t),r={left:2===this.order?new O([n[0],n[3],n[5]]):new O([n[0],n[4],n[7],n[9]]),right:2===this.order?new O([n[5],n[4],n[2]]):new O([n[9],n[8],n[6],n[3]]),span:n};return r.left._t1=v.map(0,0,1,this._t1,this._t2),r.left._t2=v.map(t,0,1,this._t1,this._t2),r.right._t1=v.map(t,0,1,this._t1,this._t2),r.right._t2=v.map(1,0,1,this._t1,this._t2),e?(e=v.map(e,t,1,0,1),r.right.split(e).left):r}extrema(){const t={};let e=[];return this.dims.forEach(function(n){let r=function(t){return t[n]},i=this.dpoints[0].map(r);t[n]=v.droots(i),3===this.order&&(i=this.dpoints[1].map(r),t[n]=t[n].concat(v.droots(i))),t[n]=t[n].filter((function(t){return t>=0&&t<=1})),e=e.concat(t[n].sort(v.numberSort))}.bind(this)),t.values=e.sort(v.numberSort).filter((function(t,n){return e.indexOf(t)===n})),t}bbox(){const t=this.extrema(),e={};return this.dims.forEach(function(n){e[n]=v.getminmax(this,n,t[n])}.bind(this)),e}overlaps(t){const e=this.bbox(),n=t.bbox();return v.bboxoverlap(e,n)}offset(t,e){if(void 0!==e){const n=this.get(t),r=this.normal(t),i={c:n,n:r,x:n.x+r.x*e,y:n.y+r.y*e};return this._3d&&(i.z=n.z+r.z*e),i}if(this._linear){const e=this.normal(0),n=this.points.map((function(n){const r={x:n.x+t*e.x,y:n.y+t*e.y};return n.z&&e.z&&(r.z=n.z+t*e.z),r}));return[new O(n)]}return this.reduce().map((function(e){return e._linear?e.offset(t)[0]:e.scale(t)}))}simple(){if(3===this.order){const t=v.angle(this.points[0],this.points[3],this.points[1]),e=v.angle(this.points[0],this.points[3],this.points[2]);if(t>0&&e<0||t<0&&e>0)return!1}const t=this.normal(0),e=this.normal(1);let n=t.x*e.x+t.y*e.y;return this._3d&&(n+=t.z*e.z),g(A(n))<w/3}reduce(){let t,e,n=0,r=0,i=.01,o=[],s=[],c=this.extrema().values;for(-1===c.indexOf(0)&&(c=[0].concat(c)),-1===c.indexOf(1)&&c.push(1),n=c[0],t=1;t<c.length;t++)r=c[t],e=this.split(n,r),e._t1=n,e._t2=r,o.push(e),n=r;return o.forEach((function(t){for(n=0,r=0;r<=1;)for(r=n+i;r<=1.01;r+=i)if(e=t.split(n,r),!e.simple()){if(r-=i,g(n-r)<i)return[];e=t.split(n,r),e._t1=v.map(n,0,1,t._t1,t._t2),e._t2=v.map(r,0,1,t._t1,t._t2),s.push(e),n=r;break}n<1&&(e=t.split(n,1),e._t1=v.map(n,0,1,t._t1,t._t2),e._t2=t._t2,s.push(e))})),s}translate(t,e,n){n="number"==typeof n?n:e;const r=this.order;let i=this.points.map(((t,i)=>(1-i/r)*e+i/r*n));return new O(this.points.map(((e,n)=>({x:e.x+t.x*i[n],y:e.y+t.y*i[n]}))))}scale(t){const e=this.order;let n=!1;if("function"==typeof t&&(n=t),n&&2===e)return this.raise().scale(n);const r=this.clockwise,i=this.points;if(this._linear)return this.translate(this.normal(0),n?n(0):t,n?n(1):t);const o=n?n(0):t,s=n?n(1):t,c=[this.offset(0,10),this.offset(1,10)],a=[],l=v.lli4(c[0],c[0].c,c[1],c[1].c);if(!l)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach((function(t){const n=a[t*e]=v.copy(i[t*e]);n.x+=(t?s:o)*c[t].n.x,n.y+=(t?s:o)*c[t].n.y})),n?([0,1].forEach((function(o){if(2!==e||!o){var s=i[o+1],c={x:s.x-l.x,y:s.y-l.y},u=n?n((o+1)/e):t;n&&!r&&(u=-u);var h=j(c.x*c.x+c.y*c.y);c.x/=h,c.y/=h,a[o+1]={x:s.x+u*c.x,y:s.y+u*c.y}}})),new O(a)):([0,1].forEach((t=>{if(2===e&&t)return;const n=a[t*e],r=this.derivative(t),o={x:n.x+r.x,y:n.y+r.y};a[t+1]=v.lli4(n,o,l,i[t+1])})),new O(a))}outline(t,e,n,r){if(e=void 0===e?t:e,this._linear){const i=this.normal(0),o=this.points[0],s=this.points[this.points.length-1];let c,a,l;void 0===n&&(n=t,r=e),c={x:o.x+i.x*t,y:o.y+i.y*t},l={x:s.x+i.x*n,y:s.y+i.y*n},a={x:(c.x+l.x)/2,y:(c.y+l.y)/2};const u=[c,a,l];c={x:o.x-i.x*e,y:o.y-i.y*e},l={x:s.x-i.x*r,y:s.y-i.y*r},a={x:(c.x+l.x)/2,y:(c.y+l.y)/2};const h=[l,a,c],f=v.makeline(h[2],u[0]),p=v.makeline(u[2],h[0]),d=[f,new O(u),p,new O(h)];return new b(d)}const i=this.reduce(),o=i.length,s=[];let c,a=[],l=0,u=this.length();const h=void 0!==n&&void 0!==r;function f(t,e,n,r,i){return function(o){const s=r/n,c=(r+i)/n,a=e-t;return v.map(o,0,1,t+s*a,t+c*a)}}i.forEach((function(i){const o=i.length();h?(s.push(i.scale(f(t,n,u,l,o))),a.push(i.scale(f(-e,-r,u,l,o)))):(s.push(i.scale(t)),a.push(i.scale(-e))),l+=o})),a=a.map((function(t){return c=t.points,c[3]?t.points=[c[3],c[2],c[1],c[0]]:t.points=[c[2],c[1],c[0]],t})).reverse();const p=s[0].points[0],d=s[o-1].points[s[o-1].points.length-1],y=a[o-1].points[a[o-1].points.length-1],g=a[0].points[0],x=v.makeline(y,p),_=v.makeline(d,g),m=[x].concat(s).concat([_]).concat(a);return new b(m)}outlineshapes(t,e,n){e=e||t;const r=this.outline(t,e).curves,i=[];for(let t=1,e=r.length;t<e/2;t++){const o=v.makeshape(r[t],r[e-t],n);o.startcap.virtual=t>1,o.endcap.virtual=t<e/2-1,i.push(o)}return i}intersects(t,e){return t?t.p1&&t.p2?this.lineIntersects(t):(t instanceof O&&(t=t.reduce()),this.curveintersects(this.reduce(),t,e)):this.selfintersects(e)}lineIntersects(t){const e=x(t.p1.x,t.p2.x),n=x(t.p1.y,t.p2.y),r=_(t.p1.x,t.p2.x),i=_(t.p1.y,t.p2.y);return v.roots(this.points,t).filter((t=>{var o=this.get(t);return v.between(o.x,e,r)&&v.between(o.y,n,i)}))}selfintersects(t){const e=this.reduce(),n=e.length-2,r=[];for(let i,o,s,c=0;c<n;c++)o=e.slice(c,c+1),s=e.slice(c+2),i=this.curveintersects(o,s,t),r.push(...i);return r}curveintersects(t,e,n){const r=[];t.forEach((function(t){e.forEach((function(e){t.overlaps(e)&&r.push({left:t,right:e})}))}));let i=[];return r.forEach((function(t){const e=v.pairiteration(t.left,t.right,n);e.length>0&&(i=i.concat(e))})),i}arcs(t){return t=t||.5,this._iterate(t,[])}_error(t,e,n,r){const i=(r-n)/4,o=this.get(n+i),s=this.get(r-i),c=v.dist(t,e),a=v.dist(t,o),l=v.dist(t,s);return g(a-c)+g(l-c)}_iterate(t,e){let n,r=0,i=1;do{n=0,i=1;let o,s,c,a,l,u=this.get(r),h=!1,f=!1,p=i,d=1;do{if(f=h,a=c,p=(r+i)/2,o=this.get(p),s=this.get(i),c=v.getccenter(u,o,s),c.interval={start:r,end:i},h=this._error(c,u,r,i)<=t,l=f&&!h,l||(d=i),h){if(i>=1){if(c.interval.end=d=1,a=c,i>1){let t={x:c.x+c.r*m(c.e),y:c.y+c.r*P(c.e)};c.e+=v.angle({x:c.x,y:c.y},t,this.get(1))}break}i+=(i-r)/2}else i=p}while(!l&&n++<100);if(n>=100)break;a=a||c,e.push(a),r=d}while(i<1);return e}}function z(t,e){return t===e||t!=t&&e!=e}function E(t,e){for(var n=t.length;n--;)if(z(t[n][0],e))return n;return-1}var S=Array.prototype.splice;function C(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}C.prototype.clear=function(){this.__data__=[],this.size=0},C.prototype.delete=function(t){var e=this.__data__,n=E(e,t);return!(n<0)&&(n==e.length-1?e.pop():S.call(e,n,1),--this.size,!0)},C.prototype.get=function(t){var e=this.__data__,n=E(e,t);return n<0?void 0:e[n][1]},C.prototype.has=function(t){return E(this.__data__,t)>-1},C.prototype.set=function(t,e){var n=this.__data__,r=E(n,t);return r<0?(++this.size,n.push([t,e])):n[r][1]=e,this};var I="object"==typeof global&&global&&global.Object===Object&&global,T="object"==typeof self&&self&&self.Object===Object&&self,R=I||T||Function("return this")(),U=R.Symbol,k=Object.prototype,N=k.hasOwnProperty,M=k.toString,B=U?U.toStringTag:void 0;var L=Object.prototype.toString;var D="[object Null]",V="[object Undefined]",F=U?U.toStringTag:void 0;function Q(t){return null==t?void 0===t?V:D:F&&F in Object(t)?function(t){var e=N.call(t,B),n=t[B];try{t[B]=void 0;var r=!0}catch(t){}var i=M.call(t);return r&&(e?t[B]=n:delete t[B]),i}(t):function(t){return L.call(t)}(t)}function X(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}var Y="[object AsyncFunction]",H="[object Function]",J="[object GeneratorFunction]",G="[object Proxy]";function W(t){if(!X(t))return!1;var e=Q(t);return e==H||e==J||e==Y||e==G}var q,$=R["__core-js_shared__"],K=(q=/[^.]+$/.exec($&&$.keys&&$.keys.IE_PROTO||""))?"Symbol(src)_1."+q:"";var Z=Function.prototype.toString;function tt(t){if(null!=t){try{return Z.call(t)}catch(t){}try{return t+""}catch(t){}}return""}var et=/^\[object .+?Constructor\]$/,nt=Function.prototype,rt=Object.prototype,it=nt.toString,ot=rt.hasOwnProperty,st=RegExp("^"+it.call(ot).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function ct(t){return!(!X(t)||(e=t,K&&K in e))&&(W(t)?st:et).test(tt(t));var e}function at(t,e){var n=function(t,e){return null==t?void 0:t[e]}(t,e);return ct(n)?n:void 0}var lt=at(R,"Map"),ut=at(Object,"create");var ht=Object.prototype.hasOwnProperty;var ft=Object.prototype.hasOwnProperty;function pt(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function dt(t,e){var n,r,i=t.__data__;return("string"==(r=typeof(n=e))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?i["string"==typeof e?"string":"hash"]:i.map}function yt(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}pt.prototype.clear=function(){this.__data__=ut?ut(null):{},this.size=0},pt.prototype.delete=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},pt.prototype.get=function(t){var e=this.__data__;if(ut){var n=e[t];return"__lodash_hash_undefined__"===n?void 0:n}return ht.call(e,t)?e[t]:void 0},pt.prototype.has=function(t){var e=this.__data__;return ut?void 0!==e[t]:ft.call(e,t)},pt.prototype.set=function(t,e){var n=this.__data__;return this.size+=this.has(t)?0:1,n[t]=ut&&void 0===e?"__lodash_hash_undefined__":e,this},yt.prototype.clear=function(){this.size=0,this.__data__={hash:new pt,map:new(lt||C),string:new pt}},yt.prototype.delete=function(t){var e=dt(this,t).delete(t);return this.size-=e?1:0,e},yt.prototype.get=function(t){return dt(this,t).get(t)},yt.prototype.has=function(t){return dt(this,t).has(t)},yt.prototype.set=function(t,e){var n=dt(this,t),r=n.size;return n.set(t,e),this.size+=n.size==r?0:1,this};function vt(t){var e=this.__data__=new C(t);this.size=e.size}vt.prototype.clear=function(){this.__data__=new C,this.size=0},vt.prototype.delete=function(t){var e=this.__data__,n=e.delete(t);return this.size=e.size,n},vt.prototype.get=function(t){return this.__data__.get(t)},vt.prototype.has=function(t){return this.__data__.has(t)},vt.prototype.set=function(t,e){var n=this.__data__;if(n instanceof C){var r=n.__data__;if(!lt||r.length<199)return r.push([t,e]),this.size=++n.size,this;n=this.__data__=new yt(r)}return n.set(t,e),this.size=n.size,this};function bt(t){var e=-1,n=null==t?0:t.length;for(this.__data__=new yt;++e<n;)this.add(t[e])}function gt(t,e){for(var n=-1,r=null==t?0:t.length;++n<r;)if(e(t[n],n,t))return!0;return!1}bt.prototype.add=bt.prototype.push=function(t){return this.__data__.set(t,"__lodash_hash_undefined__"),this},bt.prototype.has=function(t){return this.__data__.has(t)};var xt=1,_t=2;function mt(t,e,n,r,i,o){var s=n&xt,c=t.length,a=e.length;if(c!=a&&!(s&&a>c))return!1;var l=o.get(t),u=o.get(e);if(l&&u)return l==e&&u==t;var h=-1,f=!0,p=n&_t?new bt:void 0;for(o.set(t,e),o.set(e,t);++h<c;){var d=t[h],y=e[h];if(r)var v=s?r(y,d,h,e,t,o):r(d,y,h,t,e,o);if(void 0!==v){if(v)continue;f=!1;break}if(p){if(!gt(e,(function(t,e){if(s=e,!p.has(s)&&(d===t||i(d,t,n,r,o)))return p.push(e);var s}))){f=!1;break}}else if(d!==y&&!i(d,y,n,r,o)){f=!1;break}}return o.delete(t),o.delete(e),f}var Pt=R.Uint8Array;function At(t){var e=-1,n=Array(t.size);return t.forEach((function(t,r){n[++e]=[r,t]})),n}function jt(t){var e=-1,n=Array(t.size);return t.forEach((function(t){n[++e]=t})),n}var wt=1,Ot=2,zt="[object Boolean]",Et="[object Date]",St="[object Error]",Ct="[object Map]",It="[object Number]",Tt="[object RegExp]",Rt="[object Set]",Ut="[object String]",kt="[object Symbol]",Nt="[object ArrayBuffer]",Mt="[object DataView]",Bt=U?U.prototype:void 0,Lt=Bt?Bt.valueOf:void 0;function Dt(t,e){for(var n=-1,r=e.length,i=t.length;++n<r;)t[i+n]=e[n];return t}var Vt=Array.isArray;function Ft(t,e,n){var r=e(t);return Vt(t)?r:Dt(r,n(t))}function Qt(){return[]}var Xt=Object.prototype.propertyIsEnumerable,Yt=Object.getOwnPropertySymbols,Ht=Yt?function(t){return null==t?[]:(t=Object(t),function(t,e){for(var n=-1,r=null==t?0:t.length,i=0,o=[];++n<r;){var s=t[n];e(s,n,t)&&(o[i++]=s)}return o}(Yt(t),(function(e){return Xt.call(t,e)})))}:Qt;function Jt(t){return null!=t&&"object"==typeof t}function Gt(t){return Jt(t)&&"[object Arguments]"==Q(t)}var Wt=Object.prototype,qt=Wt.hasOwnProperty,$t=Wt.propertyIsEnumerable,Kt=Gt(function(){return arguments}())?Gt:function(t){return Jt(t)&&qt.call(t,"callee")&&!$t.call(t,"callee")};var Zt="object"==typeof exports&&exports&&!exports.nodeType&&exports,te=Zt&&"object"==typeof module&&module&&!module.nodeType&&module,ee=te&&te.exports===Zt?R.Buffer:void 0,ne=(ee?ee.isBuffer:void 0)||function(){return!1},re=9007199254740991,ie=/^(?:0|[1-9]\d*)$/;function oe(t,e){var n=typeof t;return!!(e=null==e?re:e)&&("number"==n||"symbol"!=n&&ie.test(t))&&t>-1&&t%1==0&&t<e}var se=9007199254740991;function ce(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=se}var ae={};function le(t){return function(e){return t(e)}}ae["[object Float32Array]"]=ae["[object Float64Array]"]=ae["[object Int8Array]"]=ae["[object Int16Array]"]=ae["[object Int32Array]"]=ae["[object Uint8Array]"]=ae["[object Uint8ClampedArray]"]=ae["[object Uint16Array]"]=ae["[object Uint32Array]"]=!0,ae["[object Arguments]"]=ae["[object Array]"]=ae["[object ArrayBuffer]"]=ae["[object Boolean]"]=ae["[object DataView]"]=ae["[object Date]"]=ae["[object Error]"]=ae["[object Function]"]=ae["[object Map]"]=ae["[object Number]"]=ae["[object Object]"]=ae["[object RegExp]"]=ae["[object Set]"]=ae["[object String]"]=ae["[object WeakMap]"]=!1;var ue="object"==typeof exports&&exports&&!exports.nodeType&&exports,he=ue&&"object"==typeof module&&module&&!module.nodeType&&module,fe=he&&he.exports===ue&&I.process,pe=function(){try{var t=he&&he.require&&he.require("util").types;return t||fe&&fe.binding&&fe.binding("util")}catch(t){}}(),de=pe&&pe.isTypedArray,ye=de?le(de):function(t){return Jt(t)&&ce(t.length)&&!!ae[Q(t)]},ve=Object.prototype.hasOwnProperty;function be(t,e){var n=Vt(t),r=!n&&Kt(t),i=!n&&!r&&ne(t),o=!n&&!r&&!i&&ye(t),s=n||r||i||o,c=s?function(t,e){for(var n=-1,r=Array(t);++n<t;)r[n]=e(n);return r}(t.length,String):[],a=c.length;for(var l in t)!e&&!ve.call(t,l)||s&&("length"==l||i&&("offset"==l||"parent"==l)||o&&("buffer"==l||"byteLength"==l||"byteOffset"==l)||oe(l,a))||c.push(l);return c}var ge=Object.prototype;function xe(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||ge)}function _e(t,e){return function(n){return t(e(n))}}var me=_e(Object.keys,Object),Pe=Object.prototype.hasOwnProperty;function Ae(t){return null!=t&&ce(t.length)&&!W(t)}function je(t){return Ae(t)?be(t):function(t){if(!xe(t))return me(t);var e=[];for(var n in Object(t))Pe.call(t,n)&&"constructor"!=n&&e.push(n);return e}(t)}function we(t){return Ft(t,je,Ht)}var Oe=1,ze=Object.prototype.hasOwnProperty;var Ee=at(R,"DataView"),Se=at(R,"Promise"),Ce=at(R,"Set"),Ie=at(R,"WeakMap"),Te="[object Map]",Re="[object Promise]",Ue="[object Set]",ke="[object WeakMap]",Ne="[object DataView]",Me=tt(Ee),Be=tt(lt),Le=tt(Se),De=tt(Ce),Ve=tt(Ie),Fe=Q;(Ee&&Fe(new Ee(new ArrayBuffer(1)))!=Ne||lt&&Fe(new lt)!=Te||Se&&Fe(Se.resolve())!=Re||Ce&&Fe(new Ce)!=Ue||Ie&&Fe(new Ie)!=ke)&&(Fe=function(t){var e=Q(t),n="[object Object]"==e?t.constructor:void 0,r=n?tt(n):"";if(r)switch(r){case Me:return Ne;case Be:return Te;case Le:return Re;case De:return Ue;case Ve:return ke}return e});var Qe=Fe,Xe=1,Ye="[object Arguments]",He="[object Array]",Je="[object Object]",Ge=Object.prototype.hasOwnProperty;function We(t,e,n,r,i,o){var s=Vt(t),c=Vt(e),a=s?He:Qe(t),l=c?He:Qe(e),u=(a=a==Ye?Je:a)==Je,h=(l=l==Ye?Je:l)==Je,f=a==l;if(f&&ne(t)){if(!ne(e))return!1;s=!0,u=!1}if(f&&!u)return o||(o=new vt),s||ye(t)?mt(t,e,n,r,i,o):function(t,e,n,r,i,o,s){switch(n){case Mt:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case Nt:return!(t.byteLength!=e.byteLength||!o(new Pt(t),new Pt(e)));case zt:case Et:case It:return z(+t,+e);case St:return t.name==e.name&&t.message==e.message;case Tt:case Ut:return t==e+"";case Ct:var c=At;case Rt:var a=r&wt;if(c||(c=jt),t.size!=e.size&&!a)return!1;var l=s.get(t);if(l)return l==e;r|=Ot,s.set(t,e);var u=mt(c(t),c(e),r,i,o,s);return s.delete(t),u;case kt:if(Lt)return Lt.call(t)==Lt.call(e)}return!1}(t,e,a,n,r,i,o);if(!(n&Xe)){var p=u&&Ge.call(t,"__wrapped__"),d=h&&Ge.call(e,"__wrapped__");if(p||d){var y=p?t.value():t,v=d?e.value():e;return o||(o=new vt),i(y,v,n,r,o)}}return!!f&&(o||(o=new vt),function(t,e,n,r,i,o){var s=n&Oe,c=we(t),a=c.length;if(a!=we(e).length&&!s)return!1;for(var l=a;l--;){var u=c[l];if(!(s?u in e:ze.call(e,u)))return!1}var h=o.get(t),f=o.get(e);if(h&&f)return h==e&&f==t;var p=!0;o.set(t,e),o.set(e,t);for(var d=s;++l<a;){var y=t[u=c[l]],v=e[u];if(r)var b=s?r(v,y,u,e,t,o):r(y,v,u,t,e,o);if(!(void 0===b?y===v||i(y,v,n,r,o):b)){p=!1;break}d||(d="constructor"==u)}if(p&&!d){var g=t.constructor,x=e.constructor;g==x||!("constructor"in t)||!("constructor"in e)||"function"==typeof g&&g instanceof g&&"function"==typeof x&&x instanceof x||(p=!1)}return o.delete(t),o.delete(e),p}(t,e,n,r,i,o))}function qe(t,e,n,r,i){return t===e||(null==t||null==e||!Jt(t)&&!Jt(e)?t!=t&&e!=e:We(t,e,n,r,qe,i))}function $e(t,e){return qe(t,e)}var Ke=function(){try{var t=at(Object,"defineProperty");return t({},"",{}),t}catch(t){}}();function Ze(t,e,n){"__proto__"==e&&Ke?Ke(t,e,{configurable:!0,enumerable:!0,value:n,writable:!0}):t[e]=n}var tn=Object.prototype.hasOwnProperty;function en(t,e,n){var r=t[e];tn.call(t,e)&&z(r,n)&&(void 0!==n||e in t)||Ze(t,e,n)}function nn(t,e,n,r){var i=!n;n||(n={});for(var o=-1,s=e.length;++o<s;){var c=e[o],a=r?r(n[c],t[c],c,n,t):void 0;void 0===a&&(a=t[c]),i?Ze(n,c,a):en(n,c,a)}return n}var rn=Object.prototype.hasOwnProperty;function on(t){if(!X(t))return function(t){var e=[];if(null!=t)for(var n in Object(t))e.push(n);return e}(t);var e=xe(t),n=[];for(var r in t)("constructor"!=r||!e&&rn.call(t,r))&&n.push(r);return n}function sn(t){return Ae(t)?be(t,!0):on(t)}var cn="object"==typeof exports&&exports&&!exports.nodeType&&exports,an=cn&&"object"==typeof module&&module&&!module.nodeType&&module,ln=an&&an.exports===cn?R.Buffer:void 0,un=ln?ln.allocUnsafe:void 0;var hn=_e(Object.getPrototypeOf,Object),fn=Object.getOwnPropertySymbols?function(t){for(var e=[];t;)Dt(e,Ht(t)),t=hn(t);return e}:Qt;function pn(t){return Ft(t,sn,fn)}var dn=Object.prototype.hasOwnProperty;function yn(t){var e=new t.constructor(t.byteLength);return new Pt(e).set(new Pt(t)),e}var vn=/\w*$/;var bn=U?U.prototype:void 0,gn=bn?bn.valueOf:void 0;var xn="[object Boolean]",_n="[object Date]",mn="[object Map]",Pn="[object Number]",An="[object RegExp]",jn="[object Set]",wn="[object String]",On="[object Symbol]",zn="[object ArrayBuffer]",En="[object DataView]",Sn="[object Float32Array]",Cn="[object Float64Array]",In="[object Int8Array]",Tn="[object Int16Array]",Rn="[object Int32Array]",Un="[object Uint8Array]",kn="[object Uint8ClampedArray]",Nn="[object Uint16Array]",Mn="[object Uint32Array]";function Bn(t,e,n){var r,i,o,s=t.constructor;switch(e){case zn:return yn(t);case xn:case _n:return new s(+t);case En:return function(t,e){var n=e?yn(t.buffer):t.buffer;return new t.constructor(n,t.byteOffset,t.byteLength)}(t,n);case Sn:case Cn:case In:case Tn:case Rn:case Un:case kn:case Nn:case Mn:return function(t,e){var n=e?yn(t.buffer):t.buffer;return new t.constructor(n,t.byteOffset,t.length)}(t,n);case mn:return new s;case Pn:case wn:return new s(t);case An:return(o=new(i=t).constructor(i.source,vn.exec(i))).lastIndex=i.lastIndex,o;case jn:return new s;case On:return r=t,gn?Object(gn.call(r)):{}}}var Ln=Object.create,Dn=function(){function t(){}return function(e){if(!X(e))return{};if(Ln)return Ln(e);t.prototype=e;var n=new t;return t.prototype=void 0,n}}();var Vn=pe&&pe.isMap,Fn=Vn?le(Vn):function(t){return Jt(t)&&"[object Map]"==Qe(t)};var Qn=pe&&pe.isSet,Xn=Qn?le(Qn):function(t){return Jt(t)&&"[object Set]"==Qe(t)},Yn=1,Hn=2,Jn=4,Gn="[object Arguments]",Wn="[object Function]",qn="[object GeneratorFunction]",$n="[object Object]",Kn={};function Zn(t,e,n,r,i,o){var s,c=e&Yn,a=e&Hn,l=e&Jn;if(n&&(s=i?n(t,r,i,o):n(t)),void 0!==s)return s;if(!X(t))return t;var u=Vt(t);if(u){if(s=function(t){var e=t.length,n=new t.constructor(e);return e&&"string"==typeof t[0]&&dn.call(t,"index")&&(n.index=t.index,n.input=t.input),n}(t),!c)return function(t,e){var n=-1,r=t.length;for(e||(e=Array(r));++n<r;)e[n]=t[n];return e}(t,s)}else{var h=Qe(t),f=h==Wn||h==qn;if(ne(t))return function(t,e){if(e)return t.slice();var n=t.length,r=un?un(n):new t.constructor(n);return t.copy(r),r}(t,c);if(h==$n||h==Gn||f&&!i){if(s=a||f?{}:function(t){return"function"!=typeof t.constructor||xe(t)?{}:Dn(hn(t))}(t),!c)return a?function(t,e){return nn(t,fn(t),e)}(t,function(t,e){return t&&nn(e,sn(e),t)}(s,t)):function(t,e){return nn(t,Ht(t),e)}(t,function(t,e){return t&&nn(e,je(e),t)}(s,t))}else{if(!Kn[h])return i?t:{};s=Bn(t,h,c)}}o||(o=new vt);var p=o.get(t);if(p)return p;o.set(t,s),Xn(t)?t.forEach((function(r){s.add(Zn(r,e,n,r,t,o))})):Fn(t)&&t.forEach((function(r,i){s.set(i,Zn(r,e,n,i,t,o))}));var d=u?void 0:(l?a?pn:we:a?sn:je)(t);return function(t,e){for(var n=-1,r=null==t?0:t.length;++n<r&&!1!==e(t[n],n,t););}(d||t,(function(r,i){d&&(r=t[i=r]),en(s,i,Zn(r,e,n,i,t,o))})),s}Kn[Gn]=Kn["[object Array]"]=Kn["[object ArrayBuffer]"]=Kn["[object DataView]"]=Kn["[object Boolean]"]=Kn["[object Date]"]=Kn["[object Float32Array]"]=Kn["[object Float64Array]"]=Kn["[object Int8Array]"]=Kn["[object Int16Array]"]=Kn["[object Int32Array]"]=Kn["[object Map]"]=Kn["[object Number]"]=Kn[$n]=Kn["[object RegExp]"]=Kn["[object Set]"]=Kn["[object String]"]=Kn["[object Symbol]"]=Kn["[object Uint8Array]"]=Kn["[object Uint8ClampedArray]"]=Kn["[object Uint16Array]"]=Kn["[object Uint32Array]"]=!0,Kn["[object Error]"]=Kn[Wn]=Kn["[object WeakMap]"]=!1;function tr(t){return Zn(t,5)}function er(t){return t}var nr=Math.max;var rr=Ke?function(t,e){return Ke(t,"toString",{configurable:!0,enumerable:!1,value:(n=e,function(){return n}),writable:!0});var n}:er,ir=rr,or=Date.now;var sr,cr,ar,lr=(sr=ir,cr=0,ar=0,function(){var t=or(),e=16-(t-ar);if(ar=t,e>0){if(++cr>=800)return arguments[0]}else cr=0;return sr.apply(void 0,arguments)});var ur=Object.prototype,hr=ur.hasOwnProperty,fr=function(t,e){return lr(function(t,e,n){return e=nr(void 0===e?t.length-1:e,0),function(){for(var r=arguments,i=-1,o=nr(r.length-e,0),s=Array(o);++i<o;)s[i]=r[e+i];i=-1;for(var c=Array(e+1);++i<e;)c[i]=r[i];return c[e]=n(s),function(t,e,n){switch(n.length){case 0:return t.call(e);case 1:return t.call(e,n[0]);case 2:return t.call(e,n[0],n[1]);case 3:return t.call(e,n[0],n[1],n[2])}return t.apply(e,n)}(t,this,c)}}(t,e,er),t+"")}((function(t,e){t=Object(t);var n=-1,r=e.length,i=r>2?e[2]:void 0;for(i&&function(t,e,n){if(!X(n))return!1;var r=typeof e;return!!("number"==r?Ae(n)&&oe(e,n.length):"string"==r&&e in n)&&z(n[e],t)}(e[0],e[1],i)&&(r=1);++n<r;)for(var o=e[n],s=sn(o),c=-1,a=s.length;++c<a;){var l=s[c],u=t[l];(void 0===u||z(u,ur[l])&&!hr.call(t,l))&&(t[l]=o[l])}return t})),pr=/\s/;var dr=/^\s+/;function yr(t){return t?t.slice(0,function(t){for(var e=t.length;e--&&pr.test(t.charAt(e)););return e}(t)+1).replace(dr,""):t}var vr="[object Symbol]";function br(t){return"symbol"==typeof t||Jt(t)&&Q(t)==vr}var gr=NaN,xr=/^[-+]0x[0-9a-f]+$/i,_r=/^0b[01]+$/i,mr=/^0o[0-7]+$/i,Pr=parseInt;function Ar(t){if("number"==typeof t)return t;if(br(t))return gr;if(X(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=X(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=yr(t);var n=_r.test(t);return n||mr.test(t)?Pr(t.slice(2),n?2:8):xr.test(t)?gr:+t}var jr=1/0,wr=17976931348623157e292;function Or(t){var e=function(t){return t?(t=Ar(t))===jr||t===-jr?(t<0?-1:1)*wr:t==t?t:0:0===t?t:0}(t),n=e%1;return e==e?n?e-n:e:0}var zr=1/0,Er=U?U.prototype:void 0,Sr=Er?Er.toString:void 0;function Cr(t){if("string"==typeof t)return t;if(Vt(t))return function(t,e){for(var n=-1,r=null==t?0:t.length,i=Array(r);++n<r;)i[n]=e(t[n],n,t);return i}(t,Cr)+"";if(br(t))return Sr?Sr.call(t):"";var e=t+"";return"0"==e&&1/t==-zr?"-0":e}function Ir(t){return null==t?"":Cr(t)}var Tr=R.isFinite,Rr=Math.min;var Ur=function(t){var e=Math[t];return function(t,n){if(t=Ar(t),(n=null==n?0:Rr(Or(n),292))&&Tr(t)){var r=(Ir(t)+"e").split("e");return+((r=(Ir(e(r[0]+"e"+(+r[1]+n)))+"e").split("e"))[0]+"e"+(+r[1]-n))}return e(t)}}("round");const kr=Symbol("fabric-path-editor-symbol"),Nr=Symbol("fabric-path-editor-record-info");var Mr,Br;!function(t){t.BACKGROUND="background",t.MAJOR_POINT="major-point",t.SUB_POINT="sub-point",t.SPLIT_POINT="split-point"}(Mr||(Mr={})),function(t){t.START="M",t.LINE="L",t.QUADRATIC_CURCE="Q",t.BEZIER_CURVE="C",t.CLOSE="z"}(Br||(Br={}));const Lr=[Br.QUADRATIC_CURCE,Br.BEZIER_CURVE];class Dr{constructor(t,e={}){this._options={},this.source=null,this.target=null,this.controllers={points:[],handlers:[],activePoints:[]},this.listeners=[],this.records={undo:[],redo:[]},this._inbuiltStatus={cancelSelectEvent:!1,extraActions:!0,autoPathMerge:!1,awaitAdd:!1},this._storePlatformStatus=null,this._updateStyle=()=>{const{points:t,handlers:e,activePoints:n,activeHandlerPoint:r}=this.controllers;t.forEach((t=>{n.includes(t)?t.item(0).set({fill:"#29ca6e"}):t.item(0).set({fill:"#ffffff"})})),e.forEach((t=>{t.point===r?t.point.item(0).set({stroke:"#4b4b4b"}):t.point.item(0).set({stroke:"#bebebe"})}))},this._platform=t,this._options=fr(e,this._options)}observe(t){this.source=t}static transformPath(t,e,n=!0){const{translate:r,scale:i,rotate:o}=e,s=n?t.path:tr(t.path);return null==s||s.forEach(((t,e)=>{const[,...n]=t;for(let t=0;t<n.length;t+=2){let n=s[e][t+1],c=s[e][t+2];void 0!==i&&(n*=i.x,c*=i.y),void 0!==o&&(n=Math.cos(o*Math.PI/180)*n-Math.sin(o*Math.PI/180)*c,c=Math.sin(o*Math.PI/180)*n+Math.cos(o*Math.PI/180)*c),void 0!==r&&(n+=r.x,c+=r.y),s[e][t+1]=n,s[e][t+2]=c}})),s}static initializePath(t,n,r=[1,0,0,1,0,0]){var i;const o=t.left,s=t.top;null===(i=t.path)||void 0===i||i.forEach((t=>{const[,...e]=t;for(let n=0;n<e.length;n+=2)t[n+1]=Ur(t[n+1],3),t[n+2]=Ur(t[n+2],3)}));const c=new e.fabric.Path(e.fabric.util.joinPath(t.path)).getCenterPoint();t.initialize(n);const a=new e.fabric.Path(n).getCenterPoint(),l=e.fabric.util.transformPoint(new e.fabric.Point(a.x-c.x,a.y-c.y),r);t.set({left:o+l.x,top:s+l.y}),t.setCoords()}static convertQuadraticToCubic(t,e){if(e[0]!==Br.QUADRATIC_CURCE)return e;const n=Array.from({length:2}).map(((t,n)=>({x:e[2*n+1],y:e[2*n+2]}))),[r,i]=n,o={x:2/3*r.x+1/3*t.x,y:2/3*r.y+1/3*t.y},s={x:2/3*r.x+1/3*i.x,y:2/3*r.y+1/3*i.y},c=i;return["C",o.x,o.y,s.x,s.y,c.x,c.y]}_toRelativeCrood(t,e){const[n,,,,r,i]=this._platform.viewportTransform;return{x:(t-r)/n,y:(e-i)/n}}_patchPath(t){if(!t.path)return;Dr.transformPath(t,{translate:{x:-t.pathOffset.x,y:-t.pathOffset.y}});const n=this._getPathSections(t.path);for(const t of n){t[0][0]!==Br.START&&(t[0]=[Br.START,...t[0].slice(t[0].length-2)]);if(t[t.length-1][0]===Br.CLOSE){const e=t[0].slice(t[0].length-2),n=t[t.length-2].slice(t[t.length-2].length-2);t[0]!==t[t.length-2]&&n[0]===e[0]&&n[1]===e[1]||t.splice(t.length-1,0,[Br.LINE,e[0],e[1]])}}t.path=n.flat(1),t.pathOffset=new e.fabric.Point(0,0)}_initBackground(){if(!this._platform)return;const t=new e.fabric.StaticCanvas(null,{width:20,height:20});t.add(new e.fabric.Rect({width:20,height:20,fill:"transparent",stroke:"#f1f1f1",strokeWidth:.5,strokeDashArray:[4,2]})),t.renderAll();const n=new e.fabric.Rect({width:this._platform.getWidth(),height:this._platform.getHeight(),fill:new e.fabric.Pattern({source:t.getElement(),repeat:"repeat"}),objectCaching:!1,selectable:!1});n[kr]=!0,n[Nr]={type:Mr.BACKGROUND},this._platform.add(n)}_initPlatformStatus(){var t;if(!this._platform)return;const e=this._platform;this._storePlatformStatus={canvasSelection:null!==(t=e.selection)&&void 0!==t&&t,objectSelections:new WeakMap(e._objects.map((t=>{var e;return[t,null===(e=t.selectable)||void 0===e||e]})))},e.selection=!0,e.preserveObjectStacking=!0,e.controlsAboveOverlay=!0,e.discardActiveObject(),e.forEachObject((t=>{t.set({selectable:!1})}))}_getPathSections(t){var e;void 0===t&&(t=null===(e=this.target)||void 0===e?void 0:e.path);return t.reduce(((t,e,n,r)=>e?(e[0]===Br.START&&t[t.length-1].length&&t.push([]),t[t.length-1].push(e),e[0]===Br.CLOSE&&n!==r.length-1&&t.push([]),t):t),[[]])}_splitInstruction(t,n){if(2===t.length)return{pre:[Br.LINE,n.x,n.y],next:[Br.LINE,t[1].x,t[1].y]};{const r=new O(t),{t:i}=r.project(n),o=r.split(i),s=new e.fabric.Path(o.left.toSVG()+o.right.toSVG()).path;return{pre:Dr.convertQuadraticToCubic({x:s[0][1],y:s[0][2]},s[1]),next:Dr.convertQuadraticToCubic({x:s[2][1],y:s[2][2]},s[3])}}}_getAroundInstructions(t){var e;const n=this.target.path,r=this._getPathSections(n),i=r.find((e=>e.includes(t))),o=i.indexOf(t);let s=i[o-1],c=i[o+1];return(null===(e=i[i.length-1])||void 0===e?void 0:e[0])===Br.CLOSE&&!s&&(s=i[i.length-2]),c&&c[0]===Br.CLOSE&&(c=i[0]),{path:i,paths:r,cur:t,pre:null!=s?s:null,next:null!=c?c:null}}_getInstructionMajorPoint(t){return this.controllers.points.find((e=>e[Nr].instruction===t))}_getAroundPoints(t){const{path:e,cur:n,pre:r,next:i}=this._getAroundInstructions(t[Nr].instruction),o={instruction:n,instructionValueIdx:n.length-2,point:{x:n[n.length-2],y:n[n.length-1]},pointType:Mr.MAJOR_POINT};let s,c;switch(n[0]){case Br.START:if(r)if(Lr.includes(r[0]))s={instruction:r,instructionValueIdx:r.length-4,point:{x:r[r.length-4],y:r[r.length-3]},pointType:Mr.SUB_POINT};else{const t=e[2%(e.length-1)];s={instruction:t,instructionValueIdx:t.length-2,point:{x:t[t.length-2],y:t[t.length-1]},pointType:Mr.MAJOR_POINT}}break;case Br.LINE:r&&(s={instruction:r,instructionValueIdx:r.length-2,point:{x:r[r.length-2],y:r[r.length-1]},pointType:Mr.MAJOR_POINT});break;case Br.QUADRATIC_CURCE:s={instruction:n,instructionValueIdx:1,point:{x:n[1],y:n[2]},pointType:Mr.SUB_POINT};break;case Br.BEZIER_CURVE:s={instruction:n,instructionValueIdx:3,point:{x:n[3],y:n[4]},pointType:Mr.SUB_POINT}}return i&&(c={instruction:i,instructionValueIdx:1,point:{x:i[1],y:i[2]},pointType:Lr.includes(i[0])?Mr.SUB_POINT:Mr.MAJOR_POINT}),{cur:o,pre:s,next:c}}_updatePathInstruction(t,e){t.splice(0,t.length,...e)}_insertPathInstruction(t,e){var n;const r=null===(n=this.target)||void 0===n?void 0:n.path;if(r){const n=r.indexOf(t);r.splice(n+1,0,e)}}_calcAbsolutePosition(t){const n=e.fabric.util.transformPoint(new e.fabric.Point(t.x,t.y),this.source.calcOwnMatrix());return{left:n.x,top:n.y}}_calcRelativeCrood(t){return e.fabric.util.transformPoint(new e.fabric.Point(t.left,t.top),e.fabric.util.invertTransform(this.source.calcOwnMatrix()))}_initPathControlPoints(t=!1){var n;const r=this._platform,i=this.target;if(!r||!i)return;const{points:o,activePoints:s}=this.controllers;this._inbuiltStatus.cancelSelectEvent=!0,r.discardActiveObject(),r.remove(...o);const c=[];null===(n=this._getPathSections(i.path))||void 0===n||n.forEach((t=>{t.forEach(((n,r)=>{var i;const s=n;if(s[0]===Br.CLOSE)return;if((null===(i=t[r+1])||void 0===i?void 0:i[0])===Br.CLOSE)return;const[a,l]=s.slice(s.length-2),u=o.pop();u&&this._observe(u,(()=>{}));const h=null!=u?u:new e.fabric.Group([new e.fabric.Circle({strokeWidth:4,radius:6,fill:"#ffffff",stroke:"#4b4b4b",originX:"center",originY:"center"})],{originX:"center",originY:"center",hasBorders:!1,hasControls:!1});h[kr]=!0,h[Nr]={type:Mr.MAJOR_POINT,instruction:s,instructionValueIdx:s.length-2},h.set(this._calcAbsolutePosition({x:a,y:l})),c.push(h)}))})),r.add(...c),this.controllers.points=c,this.controllers.activePoints=s.filter((t=>c.includes(t))),this._inbuiltStatus.cancelSelectEvent=!1,t||this._fire("update")}_createPathControlHandler(){const t=new e.fabric.Group([new e.fabric.Circle({radius:4,stroke:"#bebebe",strokeWidth:2,fill:"#bebebe",originX:"center",originY:"center"})],{originX:"center",originY:"center",hasBorders:!1,hasControls:!1});t[kr]=!0,t[Nr]={type:Mr.SUB_POINT};return{point:t,line:new e.fabric.Line([0,0,0,0],{stroke:"#bebebe",strokeWidth:1,strokeDashArray:[4,3],strokeUniform:!0,selectable:!1,evented:!1,originX:"center",originY:"center"})}}_reversePath(t){const e=[];let n=!1;for(let r=t.length-1;r>=0;r--){const i=t[r],o=t[r-1],s=null==o?void 0:o.slice(o.length-2);switch(r===t.length-1&&(i[0]===Br.CLOSE?e.push([Br.START,...s]):e.push([Br.START,...i.slice(i.length-2)])),i[0]){case Br.START:n&&e.push([Br.CLOSE]);break;case Br.LINE:e.push([Br.LINE,...s]);break;case Br.QUADRATIC_CURCE:e.push([Br.QUADRATIC_CURCE,i[1],i[2],...s]);break;case Br.BEZIER_CURVE:e.push([Br.BEZIER_CURVE,i[3],i[4],i[1],i[2],...s]);break;case Br.CLOSE:n=!0}}return e}_mergePath(t,e){const n=this._getPathSections(),r=t[Nr],i=e[Nr];let o,s,c;for(let t=0;t<n.length;){const e=n[t];if(o&&s)break;e.includes(r.instruction)&&(o=e),e.includes(i.instruction)&&(s=e),e!==o&&e!==s?t++:n.splice(t,1)}void 0!==o&&void 0!==s&&(o===s?(o.push([Br.CLOSE]),c=o):(r.instruction===o[0]&&(o=this._reversePath(o)),i.instruction===s[s.length-1]&&(s=this._reversePath(s)),s.shift(),c=o.concat(s)),n.push(c),this.target.path=n.flat(1),this._initPathControlPoints())}_observe(t,e){let{left:n=0,top:r=0}=t;Object.defineProperties(t,{left:{get:()=>n,set:t=>{if(n===t)return;const i={left:n,top:r};n=t,e({left:n,top:r},i)}},top:{get:()=>r,set:t=>{if(r===t)return;const i={left:n,top:r};r=t,e({left:n,top:r},i)}}})}_fire(t){this.target&&(this.target.set({backgroundColor:"rgba(255, 125, 125, 0.8)"}),"update"===t&&this._updatePath())}_on(t,e,n){"global"===t&&window.addEventListener(e,n),"canvas"===t&&this._platform.on(e,n),this.listeners.push({type:t,eventName:e,handler:n})}_initEvents(){(()=>{this._on("canvas","selection:created",(t=>{this._inbuiltStatus.cancelSelectEvent||this.focus(...t.selected)})),this._on("canvas","selection:updated",(t=>{this._inbuiltStatus.cancelSelectEvent||this.focus(...t.selected)})),this._on("canvas","selection:cleared",(()=>{this._inbuiltStatus.cancelSelectEvent||this.focus()}))})(),(()=>{let t;const e=[{combinationKeys:["alt"],onActivate:()=>{this._inbuiltStatus.extraActions=!1,this._inbuiltStatus.awaitAdd=!0},onDeactivate:()=>{this._inbuiltStatus.extraActions=!0,this._inbuiltStatus.awaitAdd=!1}},{combinationKeys:["ctrl"],onActivate:()=>{this._inbuiltStatus.autoPathMerge=!0},onDeactivate:()=>{this._inbuiltStatus.autoPathMerge=!1}},{key:"backspace",onActivate:()=>{const{handlers:t,activeHandlerPoint:e,activePoints:n}=this.controllers;if(e){const n=null==t?void 0:t.find((t=>t.point===e));n&&(this._inbuiltStatus.cancelSelectEvent=!0,this.transferToLine(n.belong,n.belongPosition),this._updatePointHandlers(),this._updateStyle(),this._inbuiltStatus.cancelSelectEvent=!1)}else this.remove(...n)}},{key:"z",combinationKeys:["ctrl"],onActivate:()=>{if(this.records.undo.length>1){let t=this.records.undo.pop();t&&(this.records.redo.push(t),t=this.records.undo[this.records.undo.length-1],t&&this._initializePath(t.path,t.left,t.top))}}},{key:"z",combinationKeys:["ctrl","shift"],onActivate:()=>{let t=this.records.redo.pop();t&&(this.records.undo.push(t),this._initializePath(t.path,t.left,t.top))}}],n=n=>{var r;let i=n.key.toLowerCase();const o=e.filter((t=>{const{key:e,combinationKeys:r=[]}=t;return("keyup"!==n.type||e!==i)&&(!(!e&&0===r.length)&&!(e&&e!==i||r.some((t=>!n[`${t}Key`]))))}));o.sort(((t,e)=>{var n,r,i,o;return t.key&&!e.key?-1:(null!==(r=null===(n=e.combinationKeys)||void 0===n?void 0:n.length)&&void 0!==r?r:0)-(null!==(o=null===(i=t.combinationKeys)||void 0===i?void 0:i.length)&&void 0!==o?o:0)}));const s=o[0];t!==s&&(null===(r=null==t?void 0:t.onDeactivate)||void 0===r||r.call(t),t=s,null==t||t.onActivate())};this._on("global","keydown",n.bind(this)),this._on("global","keyup",n.bind(this)),this._on("global","blur",(()=>{var e;t&&(null===(e=t.onDeactivate)||void 0===e||e.call(t),t=void 0)}))})(),(()=>{this._on("canvas","mouse:dblclick",(t=>{var e,n;const r=t.target;if((null===(e=r[Nr])||void 0===e?void 0:e.type)===Mr.MAJOR_POINT){const{pre:t,next:e}=this._getAroundPoints(r);[t,e].every((t=>!t||(null==t?void 0:t.pointType)===Mr.SUB_POINT))?this.transferToLine(r,"both"):this.transferToCurce(r)}if((null===(n=r[Nr])||void 0===n?void 0:n.type)===Mr.SUB_POINT){const{cur:t,pre:e}=this._getAroundInstructions(r[Nr].instruction);if(t[0]===Br.BEZIER_CURVE)return;t[0]=Br.BEZIER_CURVE,this._updatePathInstruction(t,Dr.convertQuadraticToCubic({x:e[e.length-2],y:e[e.length-1]},t))}this._updatePointHandlers()}))})(),(()=>{let t,e,n=[];this._on("canvas","mouse:down",(()=>{const{activePoint:e,points:r}=this.controllers;if(!e)return;const{pre:i,next:o}=this._getAroundInstructions(e[Nr].instruction);i&&o||(t=e,n=r.filter((t=>{if(t===e)return!1;const{pre:n,next:r}=this._getAroundInstructions(t[Nr].instruction);return!n||!r})))})),this._on("canvas","mouse:move",(r=>{t&&(e=void 0,n.forEach((t=>{this._inbuiltStatus.autoPathMerge&&t.containsPoint(r.pointer)?(t.scale(1.2),e=t):t.scale(1)})))})),this._on("canvas","mouse:up",(()=>{t&&e&&this._mergePath(t,e),t=void 0,e=void 0,n.forEach((t=>t.scale(1))),n.length=0}))})(),(()=>{let t,n,r;this._on("canvas","mouse:down:before",(r=>{var i;const{e:o}=r;if(this.target&&this._inbuiltStatus.awaitAdd&&(null===(i=r.target[Nr])||void 0===i?void 0:i.type)===Mr.BACKGROUND){const{activePoint:r}=this.controllers;if(!r)return;const{paths:i,path:s,pre:c,cur:a,next:l}=this._getAroundInstructions(r[Nr].instruction);if(c&&l)return;const{x:u,y:h}=this._toRelativeCrood(o.offsetX,o.offsetY),f=e.fabric.util.transformPoint(new e.fabric.Point(u,h),e.fabric.util.invertTransform(this.source.calcOwnMatrix()));c||(t=[Br.START,f.x,f.y],n=a,a[0]=Br.LINE,s.unshift(t)),l||(t=[Br.LINE,f.x,f.y],n=t,s.push(t)),this.target.path=i.flat(1),this._initPathControlPoints()}})),this._on("canvas","mouse:down",(()=>{t&&(r=this._getInstructionMajorPoint(t),r&&(this.focus(r),this._platform.selection=!1))})),this._on("canvas","mouse:move",(t=>{const{e:i}=t;if(r&&n){if(r.containsPoint(t.pointer)&&n[0]!==Br.QUADRATIC_CURCE)return;const{x:o,y:s}=this._toRelativeCrood(i.offsetX,i.offsetY),c=e.fabric.util.transformPoint(new e.fabric.Point(o,s),e.fabric.util.invertTransform(this.source.calcOwnMatrix()));n[0]===Br.QUADRATIC_CURCE?(n[1]=c.x,n[2]=c.y):(n[0]=Br.QUADRATIC_CURCE,n.splice(1,0,c.x,c.y)),this._updatePointHandlers()}})),this._on("canvas","mouse:up",(()=>{t=void 0,n=void 0,r=void 0,this._platform.selection=!0,this._fire("update")}))})(),(()=>{this._on("canvas","object:modified",(()=>{this._fire("update")}))})(),(()=>{let t;const n=()=>{t&&(this._platform.remove(t),t=void 0)};this._on("canvas","mouse:move",(r=>{var i,o;if(!this.target)return n();if((null===(i=r.target)||void 0===i?void 0:i[kr])&&[Mr.MAJOR_POINT,Mr.SUB_POINT].includes(null===(o=r.target[Nr])||void 0===o?void 0:o.type))return n();if(!this.target.containsPoint(r.pointer))return n();const{x:s,y:c}=this._calcRelativeCrood({left:r.pointer.x,top:r.pointer.y}),a=this._getPathSections();let l,u,h=1/0;for(let t of a)for(let e=1;e<t.length;e++){let n=[];if(t[e][0]===Br.START)continue;if(t[e][0]===Br.CLOSE){const r=t[e-1].slice(-2),i=t[0].slice(-2);n=[r,...i,...i]}else if(t[e][0]===Br.LINE){const r=t[e-1].slice(-2),i=t[e].slice(-2);n=[...r,...i,...i]}else{n=[...t[e-1].slice(-2),...t[e].slice(1)]}const r=new O(...n.reduce(((t,e,n,r)=>(n%2==0&&t.push({x:r[n],y:r[n+1]}),t)),[])).project({x:s,y:c});r.d&&r.d<h&&(h=r.d,l=t[e],u={x:r.x,y:r.y})}if(h<5&&l&&u){const{x:r,y:i}=u,{left:o,top:s}=this._calcAbsolutePosition({x:r,y:i});if(t&&t.left===o&&t.top===s)return;n();const{pre:c}=this._getAroundInstructions(l),a=new e.fabric.Group([new e.fabric.Circle({radius:10,stroke:"#f00",strokeWidth:1,fill:"transparent",originX:"center",originY:"center"})]);a.set({left:o,top:s,originX:"center",originY:"center",selectable:!1}),a[kr]=!0,a[Nr]={type:Mr.SPLIT_POINT,instruction:l},a.on("mousedown",(()=>{const t=this._splitInstruction([...c.slice(-2),...l.slice(1)].reduce(((t,e,n,r)=>(n%2==0&&t.push({x:r[n],y:r[n+1]}),t)),[]),{x:r,y:i});this._updatePathInstruction(l,t.pre),this._insertPathInstruction(l,t.next),this._initPathControlPoints()})),this._platform.insertAt(a,this._platform._objects.indexOf(this.target)+1,!1),t=a,this._platform.renderAll()}else n()}))})()}async enterEditing(t){if(!this.source||"path"!==this.source.type)throw Error("Please observe target path before editing.");this._initBackground(),this._initPlatformStatus(),this.target=await new Promise((t=>this.source.clone(t))),this._patchPath(this.target),t&&t(this.target),this.target[kr]=!0,this.target.set({selectable:!1,evented:!1,objectCaching:!1}),this._platform.add(this.target),this._platform.renderOnAddRemove=!1,this._initPathControlPoints(),this._platform.renderOnAddRemove=!0,this._platform.renderAll(),this._initEvents(),this.focus(this.controllers.points[0])}_initializePath(t,e,n){this.target&&(this.target.initialize(t),this.target.set({left:e,top:n}).setCoords(),this._initPathControlPoints(!0),this._platform.renderAll())}_updatePath(t){if(!this.target)return;const n=null!=t?t:e.fabric.util.joinPath(this.target.path),r=this.records.undo[this.records.undo.length-1];if(r){const t=new e.fabric.Path(r.path).getCenterPoint(),i=this.target.path;this.target.initialize(n),this.target.path=i;const o=this.target.getCenterPoint(),s=e.fabric.util.transformPoint(new e.fabric.Point(o.x-t.x,o.y-t.y),[1,0,0,1,0,0]);this.target.set({left:r.left+s.x,top:r.top+s.y}),this.target.setCoords()}this.records.redo.length=0,this.records.undo.push({left:this.target.left,top:this.target.top,path:e.fabric.util.joinPath(this.target.path)})}updatePath(t){this._updatePath(t),this._initPathControlPoints(!0),this._platform.renderAll()}leaveEditing(){}_updatePointHandlers(){const t=this._platform,{activePoint:e}=this.controllers;if(!e)return t.remove(...this.controllers.handlers.map((t=>[t.point,t.line])).flat(1)),this.controllers.handlers=[],void(this.controllers.activeHandlerPoint=void 0);const{pre:n,cur:r,next:i}=this._getAroundInstructions(e[Nr].instruction),o=[];[r[0]===Br.START&&n?this._getAroundInstructions(n).pre:n,r,i].map(((t,e)=>{if(!t)return;const n=this._getInstructionMajorPoint(t);if(!n)return;const{pre:r,next:i}=this._getAroundPoints(n);r&&o.push({item:r,belong:n,belongPosition:"pre",hidden:0===e}),i&&o.push({item:i,belong:n,belongPosition:"next",hidden:2===e||i.instruction[0]===Br.QUADRATIC_CURCE})}));const s=o.map((({item:t,belong:e,belongPosition:n,hidden:r})=>{var i;if(!t)return;const{point:o,pointType:s,instruction:c,instructionValueIdx:a}=t;if(!o)return;if(s!==Mr.SUB_POINT)return;const l=null!==(i=this.controllers.handlers.find((t=>t.belong===e&&t.belongPosition===n)))&&void 0!==i?i:this._createPathControlHandler();return l.belong=e,l.belongPosition=n,l.hidden=r,l.point[Nr].instruction=c,l.point[Nr].instructionValueIdx=a,l.point.set({visible:!r}),l.line.set({visible:!r}),this._observe(l.point,(({left:t,top:n})=>{const{x:r,y:i}=this._calcRelativeCrood({left:t,top:n});l.line.set({x1:e.left,y1:e.top,x2:l.point.left,y2:l.point.top}),c[a]=r,c[a+1]=i,this._inbuiltStatus.extraActions?this.controllers.activeHandlerPoint&&l.mirror&&!l.mirror.hidden&&(l.mirror.point.set({left:2*e.left-l.point.left,top:2*e.top-l.point.top}),l.mirror.line.set({x1:e.left,y1:e.top,x2:l.mirror.point.left,y2:l.mirror.point.top})):(l.mirror&&(l.mirror.mirror=void 0),l.mirror=void 0),l.point.setCoords()})),l.point.set(this._calcAbsolutePosition(o)),l}));for(const t of s)if("pre"===(null==t?void 0:t.belongPosition)){const e=t.belong;if(!e)continue;const n=s.find((t=>(null==t?void 0:t.belong)===e&&"next"===(null==t?void 0:t.belongPosition)));void 0!==t&&void 0!==n&&t.point.left+n.point.left===2*e.left&&t.point.top+n.point.top===2*e.top&&(t.mirror=n,n.mirror=t)}t.remove(...this.controllers.handlers.filter((t=>!s.includes(t))).map((t=>[t.point,t.line])).flat(1)),this.controllers.handlers=s.filter(Boolean),s.every((t=>(null==t?void 0:t.point)!==this.controllers.activeHandlerPoint))&&(this.controllers.activeHandlerPoint=void 0),t.add(...this.controllers.handlers.filter((t=>void 0===t.point.canvas)).map((t=>[t.point,t.line])).flat(1))}move(t,e,n={pre:!0,next:!0}){const{left:r,top:i}=e,o=t.group,{scaleX:s,scaleY:c}=t,{scaleX:a,scaleY:l}=o?{scaleX:1/o.scaleX,scaleY:1/o.scaleY}:{scaleX:1,scaleY:1};t.set({scaleX:a,scaleY:l});const u=t[Nr].instruction,h=this._calcRelativeCrood({left:r,top:i}),f=h.x-u[u.length-2],p=h.y-u[u.length-1],{path:d}=this._getAroundInstructions(t[Nr].instruction),{handlers:y}=this.controllers;if(u[u.length-2]=h.x,u[u.length-1]=h.y,!n.pre&&!n.next)return;const{pre:v,next:b}=this._getAroundPoints(t);[{position:"pre",point:v},{position:"next",point:b}].forEach((({point:e,position:o})=>{if(!e||!n[o])return;if(e.pointType!==Mr.SUB_POINT)return;if("next"===o&&e.instruction[0]===Br.QUADRATIC_CURCE)return;const{instruction:u,instructionValueIdx:d,point:v}=e,b={left:v.x+f-h.x,top:v.y+p-h.y};b.left*=s/a,b.top*=c/l,u[d]=h.x+b.left,u[d+1]=h.y+b.top;const g=null==y?void 0:y.find((e=>e.belong===t&&e.belongPosition===o));g&&(this._inbuiltStatus.extraActions?g.point.set(this._calcAbsolutePosition({x:u[d],y:u[d+1]})):g.line.set({x1:r,y1:i,x2:g.point.left,y2:g.point.top}))}));const g=d[d.length-2];g&&u!==g&&g[0]!==Br.CLOSE&&d[0]===u&&d[d.length-1][0]===Br.CLOSE&&(g[g.length-2]=h.x,g[g.length-1]=h.y),t.setCoords()}focus(...t){const n=this._platform,{handlers:r}=this.controllers;this._inbuiltStatus.cancelSelectEvent=!0,t=t.filter((t=>void 0!==t[Nr])),n.discardActiveObject();const i=t=>{this._observe(t,(()=>{t._objects.forEach((t=>{var n;if((null===(n=t[Nr])||void 0===n?void 0:n.type)!==Mr.MAJOR_POINT)return;const r=t,i=e.fabric.util.qrDecompose(r.calcTransformMatrix()),o=i.translateX,s=i.translateY;this.move(r,{left:o,top:s})}))}))},o=t=>{this._observe(t,(({left:e,top:n})=>{t.group||this.move(t,{left:e,top:n})}))},s=[],c=[];if(t.length)if(t.forEach((t=>{if(t[Nr].type===Mr.MAJOR_POINT&&s.push(t),t[Nr].type===Mr.SUB_POINT){const e=r.find((e=>e.point===t));s.push(e.belong),c.push(t)}})),t.length>1){const r=new e.fabric.ActiveSelection(t,{canvas:n,lockScalingFlip:!0,lockRotation:!0,originX:"center",originY:"center"});n.setActiveObject(r),i(r)}else n.setActiveObject(t[0]),o(s[0]);this.controllers.activePoints=s,this.controllers.activePoint=1===s.length?s[0]:void 0,this.controllers.activeHandlerPoint=1===c.length?c[0]:void 0,this._updatePointHandlers(),this._updateStyle(),n.renderAll(),this._inbuiltStatus.cancelSelectEvent=!1}remove(...t){if(!this.target)return;if(0===(t=t.filter((t=>t[Nr].type===Mr.MAJOR_POINT&&void 0!==t[Nr].instruction))).length)return;const e=this._platform,n=this.target.path;if(!n)return;let r=this._getPathSections(n);t.forEach((t=>{var e;const{instruction:n}=t[Nr];if(!n)return;const i=r.findIndex((t=>t.includes(n))),o=r[i],s=o.indexOf(n),c=o.slice(0,s),a=o.slice(s+1);if((null===(e=a[a.length-1])||void 0===e?void 0:e[0])===Br.CLOSE){a.pop();const t=a[a.length-1];if(0===s&&t&&$e(t.slice(t.length-2),n.slice(n.length-2)))a.pop();else{const e=c[0];(null==e?void 0:e[0])===Br.START&&(e[0]=Br.LINE,$e(e.slice(e.length-2),t.slice(t.length-2))&&c.shift())}a.push(...c),r.splice(i,1,a)}else 1===c.length&&c[0][0]===Br.START?r.splice(i,1,a):r.splice(i,1,c,a);n[0]!==Br.START&&a.unshift(tr(n));const l=a[0];l&&(l.splice(1,{[Br.START]:0,[Br.LINE]:0,[Br.BEZIER_CURVE]:4,[Br.QUADRATIC_CURCE]:2}[l[0]]),l[0]=Br.START)})),this.target.path=r.flat(1),this._initPathControlPoints(),this.focus(),e.requestRenderAll()}transferToLine(t,e){if(!this.controllers.points.includes(t))return;const{cur:n,next:r,pre:i}=this._getAroundInstructions(t[Nr].instruction);if("pre"===e||"both"===e){const t=n[0]===Br.START?i:n;t&&(t.splice(1,{[Br.BEZIER_CURVE]:4,[Br.QUADRATIC_CURCE]:2}[t[0]]),t[0]=Br.LINE)}"next"!==e&&"both"!==e||r&&(r.splice(1,{[Br.BEZIER_CURVE]:4,[Br.QUADRATIC_CURCE]:2}[r[0]]),r[0]=Br.LINE),this._platform.requestRenderAll()}transferToCurce(t){if(!this.controllers.points.includes(t))return;const{cur:e,pre:n,next:r}=this._getAroundInstructions(t[Nr].instruction);if(!n&&!r)return;const i=e[0]===Br.START&&n?this._getAroundInstructions(n).pre:n;if(i&&r){const t=[i,e,r].map((t=>({x:t[t.length-2],y:t[t.length-1]}))),o=this._splitInstruction(O.quadraticFromPoints(...t).points,t[1]),s=e[0]===Br.START?n:e;s&&!Lr.includes(s[0])&&this._updatePathInstruction(s,o.pre),r&&!Lr.includes(r[0])&&this._updatePathInstruction(r,o.next)}else{const t={x:e[e.length-2],y:e[e.length-1]},o=null!=r?r:i,s={x:o[o.length-2],y:o[o.length-1]},c=Math.sqrt(Math.pow(t.x-s.x,2)+Math.pow(t.y-s.y,2)),a={x:t.x+(s.y-t.y)/c*(c/3),y:t.y+(s.x-t.x)/c*(c/3)};if(i){const r=e[0]===Br.START?n:e;this._updatePathInstruction(r,[Br.QUADRATIC_CURCE,a.x,a.y,t.x,t.y])}else r&&this._updatePathInstruction(r,[Br.QUADRATIC_CURCE,a.x,a.y,s.x,s.y])}}destroy(){}}return Dr}));
